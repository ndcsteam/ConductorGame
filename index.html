<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro:bit Radio XYZ 座標讀取器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                colors: {
                    primary: '#5D5CDE',
                },
            },
        },
    }
    </script>
    <style>
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .chart-bar {
            position: absolute;
            bottom: 0;
            width: 30%;
            transition: height 0.2s ease-out;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .x-bar {
            left: 5%;
            background-color: #ef4444;
        }
        .y-bar {
            left: 35%;
            background-color: #22c55e;
        }
        .z-bar {
            left: 65%;
            background-color: #3b82f6;
        }
        .dark .chart-container {
            background-color: #1e1e1e;
        }
        .dark .value-display {
            background-color: #2d2d2d;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <h1 class="text-3xl font-bold mb-6 text-center text-primary">Micro:bit Radio XYZ 座標讀取器</h1>
        
        <div class="bg-yellow-100 dark:bg-yellow-900 p-4 rounded-lg mb-6 text-yellow-800 dark:text-yellow-200">
            <h3 class="font-bold text-lg mb-2">系統設定指南</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h4 class="font-semibold mb-1">發送端 Micro:bit:</h4>
                    <ol class="list-decimal list-inside ml-2 text-sm">
                        <li>設定 radio 分組為 1</li>
                        <li>讀取加速度計 X、Y、Z 值</li>
                        <li>使用格式: X:123,Y:456,Z:789</li>
                        <li>此裝置可用電池供電並移動</li>
                    </ol>
                    <div class="mt-2 p-2 bg-white dark:bg-gray-950 rounded text-xs font-mono overflow-auto">
                        radio.setGroup(1)<br>
                        basic.forever(function() {<br>
                        &nbsp;&nbsp;let x = input.acceleration(Dimension.X)<br>
                        &nbsp;&nbsp;let y = input.acceleration(Dimension.Y)<br>
                        &nbsp;&nbsp;let z = input.acceleration(Dimension.Z)<br>
                        &nbsp;&nbsp;let data = "X:" + x + ",Y:" + y + ",Z:" + z<br>
                        &nbsp;&nbsp;radio.sendString(data)<br>
                        &nbsp;&nbsp;basic.pause(100)<br>
                        })
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold mb-1">接收端 Micro:bit:</h4>
                    <ol class="list-decimal list-inside ml-2 text-sm">
                        <li>設定相同的 radio 分組 1</li>
                        <li>接收 radio 訊息</li>
                        <li>通過 USB 序列傳輸轉發數據</li>
                        <li>此裝置需要連接到電腦</li>
                    </ol>
                    <div class="mt-2 p-2 bg-white dark:bg-gray-950 rounded text-xs font-mono overflow-auto">
                        radio.setGroup(1)<br>
                        basic.showIcon(IconNames.Square)<br>
                        radio.onReceivedString(function(data) {<br>
                        &nbsp;&nbsp;serial.writeLine(data)<br>
                        &nbsp;&nbsp;led.toggle(4, 0)<br>
                        })
                    </div>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-6 shadow-md">
                <h2 class="text-xl font-semibold mb-4">連接與控制</h2>
                
                <div class="mb-4">
                    <button id="connectBtn" class="w-full bg-primary hover:bg-opacity-90 text-white font-medium py-2 px-4 rounded-md transition">
                        連接接收端 Micro:bit
                    </button>
                </div>
                
                <div id="statusContainer" class="mb-4 p-3 bg-gray-200 dark:bg-gray-700 rounded-md">
                    <p id="statusText">尚未連接</p>
                </div>
                
                <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-md text-blue-800 dark:text-blue-200 text-sm">
                    <p class="font-semibold">數據流:</p>
                    <div id="rawData" class="font-mono mt-1 h-16 overflow-y-auto bg-white dark:bg-gray-900 p-2 rounded">
                        等待接收數據...
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-6 shadow-md">
                <h2 class="text-xl font-semibold mb-4">XYZ 座標數據</h2>
                
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="value-display bg-gray-200 dark:bg-gray-700 rounded-md p-3 text-center">
                        <div class="text-red-500 font-bold text-lg">X</div>
                        <div id="xValue" class="text-2xl font-mono">0</div>
                    </div>
                    <div class="value-display bg-gray-200 dark:bg-gray-700 rounded-md p-3 text-center">
                        <div class="text-green-500 font-bold text-lg">Y</div>
                        <div id="yValue" class="text-2xl font-mono">0</div>
                    </div>
                    <div class="value-display bg-gray-200 dark:bg-gray-700 rounded-md p-3 text-center">
                        <div class="text-blue-500 font-bold text-lg">Z</div>
                        <div id="zValue" class="text-2xl font-mono">0</div>
                    </div>
                </div>
                
                <div class="chart-container bg-gray-200 rounded-md p-2">
                    <div id="xBar" class="chart-bar x-bar" style="height: 50%;"></div>
                    <div id="yBar" class="chart-bar y-bar" style="height: 50%;"></div>
                    <div id="zBar" class="chart-bar z-bar" style="height: 50%;"></div>
                    <div class="absolute bottom-0 left-0 w-full border-t border-gray-400 dark:border-gray-600"></div>
                </div>
                
                <div class="flex justify-between mt-2 px-2 text-sm">
                    <div class="text-red-500">X</div>
                    <div class="text-green-500">Y</div>
                    <div class="text-blue-500">Z</div>
                </div>
            </div>
        </div>
        
        <div class="mt-6 bg-gray-100 dark:bg-gray-800 rounded-lg p-6 shadow-md">
            <h2 class="text-xl font-semibold mb-4">數據記錄</h2>
            <div class="overflow-auto max-h-60">
                <table class="min-w-full">
                    <thead>
                        <tr class="bg-gray-200 dark:bg-gray-700">
                            <th class="py-2 px-4 text-left">時間</th>
                            <th class="py-2 px-4 text-left">X</th>
                            <th class="py-2 px-4 text-left">Y</th>
                            <th class="py-2 px-4 text-left">Z</th>
                        </tr>
                    </thead>
                    <tbody id="dataLog">
                        <!-- 數據紀錄將會動態添加在這裡 -->
                    </tbody>
                </table>
            </div>
            <div class="mt-3 flex justify-end">
                <button id="clearLogBtn" class="bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 py-1 px-3 rounded-md">
                    清除記錄
                </button>
            </div>
        </div>
        
        <div class="mt-6 bg-amber-50 dark:bg-amber-950 rounded-lg p-6 shadow-md">
            <h2 class="text-xl font-semibold mb-4 text-amber-800 dark:text-amber-200">故障排除指南</h2>
            <ul class="space-y-2 text-amber-700 dark:text-amber-300">
                <li class="flex items-start">
                    <span class="inline-block w-5 h-5 bg-amber-200 dark:bg-amber-800 rounded-full text-center mr-2 flex-shrink-0">!</span>
                    <span>如果看到 <code class="px-1 py-0.5 bg-amber-100 dark:bg-amber-900 rounded">JSON 解析錯誤</code>，請使用簡單格式的 micro:bit 程式碼（見上方指南）</span>
                </li>
                <li class="flex items-start">
                    <span class="inline-block w-5 h-5 bg-amber-200 dark:bg-amber-800 rounded-full text-center mr-2 flex-shrink-0">!</span>
                    <span>確保兩個 micro:bit 都設定了相同的 radio 分組（程式碼中為 1）</span>
                </li>
                <li class="flex items-start">
                    <span class="inline-block w-5 h-5 bg-amber-200 dark:bg-amber-800 rounded-full text-center mr-2 flex-shrink-0">!</span>
                    <span>接收端 micro:bit 必須先連接到電腦，再點擊「連接」按鈕</span>
                </li>
                <li class="flex items-start">
                    <span class="inline-block w-5 h-5 bg-amber-200 dark:bg-amber-800 rounded-full text-center mr-2 flex-shrink-0">!</span>
                    <span>如果看到數據但顯示異常，請嘗試重新啟動兩個 micro:bit</span>
                </li>
            </ul>
        </div>
    </div>

    <script>
        // 檢測暗色模式
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // 全域變數
        let port = null;
        let reader = null;
        let readLoop = false;
        let lastDataTime = 0;

        // DOM 元素
        const connectBtn = document.getElementById('connectBtn');
        const statusText = document.getElementById('statusText');
        const rawData = document.getElementById('rawData');
        const xValue = document.getElementById('xValue');
        const yValue = document.getElementById('yValue');
        const zValue = document.getElementById('zValue');
        const xBar = document.getElementById('xBar');
        const yBar = document.getElementById('yBar');
        const zBar = document.getElementById('zBar');
        const dataLog = document.getElementById('dataLog');
        const clearLogBtn = document.getElementById('clearLogBtn');

        // 連接到 Micro:bit
        connectBtn.addEventListener('click', async () => {
            if (port) {
                await disconnectFromDevice();
                return;
            }

            try {
                statusText.textContent = '請選擇接收端 micro:bit 裝置...';
                
                // 檢查瀏覽器支援
                if (!navigator.serial) {
                    throw new Error('您的瀏覽器不支援 Web Serial API。請使用 Chrome、Edge 或其他支援的瀏覽器。');
                }
                
                // 請求序列埠
                port = await navigator.serial.requestPort();
                
                statusText.textContent = '連接中...';
                
                // 開啟序列埠 (波特率設為 115200)
                await port.open({ baudRate: 115200 });
                
                // 設置讀取器
                const decoder = new TextDecoder();
                reader = port.readable.getReader();
                readLoop = true;
                
                statusText.textContent = '已連接 - 等待數據中';
                connectBtn.textContent = '中斷連接';
                
                // 開始讀取數據
                let buffer = '';
                
                while (readLoop) {
                    const { value, done } = await reader.read();
                    if (done) {
                        break;
                    }
                    
                    // 將收到的數據添加到緩衝區
                    buffer += decoder.decode(value);
                    
                    // 處理完整行
                    let newlineIndex;
                    while ((newlineIndex = buffer.indexOf('\n')) !== -1) {
                        const line = buffer.substring(0, newlineIndex).trim();
                        buffer = buffer.substring(newlineIndex + 1);
                        
                        if (line) {
                            processSerialData(line);
                        }
                    }
                }
                
            } catch (error) {
                console.error('連接錯誤:', error);
                statusText.textContent = `錯誤: ${error.message}`;
                await disconnectFromDevice();
            }
        });

        // 處理序列數據 - 增強版
        function processSerialData(line) {
            try {
                // 更新原始數據顯示
                rawData.textContent = line;
                
                // 記錄接收時間
                const now = new Date();
                lastDataTime = now.getTime();
                
                // 處理數據 - 支援兩種格式:
                
                // 1. 嘗試解析 JSON 格式 {"x":123,"y":456,"z":789}
                if (line.trim().startsWith('{') && line.trim().endsWith('}')) {
                    try {
                        const data = JSON.parse(line);
                        if ('x' in data && 'y' in data && 'z' in data) {
                            updateDisplay(data.x, data.y, data.z);
                            statusText.textContent = `接收中 (JSON) - 上次更新: ${now.toLocaleTimeString()}`;
                            return;
                        }
                    } catch (jsonError) {
                        console.warn('JSON解析錯誤:', jsonError.message);
                        // 繼續嘗試其他格式
                    }
                }
                
                // 2. 嘗試解析簡單格式 X:123,Y:456,Z:789
                if (line.includes('X:') && line.includes('Y:') && line.includes('Z:')) {
                    try {
                        let x = 0, y = 0, z = 0;
                        
                        // 提取 X 值
                        const xMatch = line.match(/X:(-?\d+)/);
                        if (xMatch && xMatch[1]) {
                            x = parseInt(xMatch[1], 10);
                        }
                        
                        // 提取 Y 值
                        const yMatch = line.match(/Y:(-?\d+)/);
                        if (yMatch && yMatch[1]) {
                            y = parseInt(yMatch[1], 10);
                        }
                        
                        // 提取 Z 值
                        const zMatch = line.match(/Z:(-?\d+)/);
                        if (zMatch && zMatch[1]) {
                            z = parseInt(zMatch[1], 10);
                        }
                        
                        updateDisplay(x, y, z);
                        statusText.textContent = `接收中 (簡單格式) - 上次更新: ${now.toLocaleTimeString()}`;
                        return;
                    } catch (parseError) {
                        console.warn('格式解析錯誤:', parseError.message);
                    }
                }
                
                // 3. 嘗試從任何包含數字的字符串中提取數據
                try {
                    const numbers = line.match(/-?\d+/g);
                    if (numbers && numbers.length >= 3) {
                        const x = parseInt(numbers[0], 10);
                        const y = parseInt(numbers[1], 10);
                        const z = parseInt(numbers[2], 10);
                        
                        updateDisplay(x, y, z);
                        statusText.textContent = `接收中 (數字序列) - 上次更新: ${now.toLocaleTimeString()}`;
                        return;
                    }
                } catch (numError) {
                    console.warn('數字提取錯誤:', numError.message);
                }
                
                // 如果所有解析方法都失敗了
                console.warn('無法識別的數據格式:', line);
                
            } catch (e) {
                console.error('處理數據錯誤:', e, line);
            }
        }

        // 更新顯示
        function updateDisplay(x, y, z) {
            xValue.textContent = x;
            yValue.textContent = y;
            zValue.textContent = z;
            
            // 更新圖表，範圍從 -2000 到 2000，轉換為 0-100%
            const xPercent = ((x + 2000) / 4000) * 100;
            const yPercent = ((y + 2000) / 4000) * 100;
            const zPercent = ((z + 2000) / 4000) * 100;
            
            xBar.style.height = `${Math.min(Math.max(xPercent, 0), 100)}%`;
            yBar.style.height = `${Math.min(Math.max(yPercent, 0), 100)}%`;
            zBar.style.height = `${Math.min(Math.max(zPercent, 0), 100)}%`;
            
            // 記錄數據
            logData(x, y, z);
        }

        // 記錄數據
        function logData(x, y, z) {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="py-1 px-4 border-t border-gray-200 dark:border-gray-700">${timeString}</td>
                <td class="py-1 px-4 border-t border-gray-200 dark:border-gray-700 text-red-500">${x}</td>
                <td class="py-1 px-4 border-t border-gray-200 dark:border-gray-700 text-green-500">${y}</td>
                <td class="py-1 px-4 border-t border-gray-200 dark:border-gray-700 text-blue-500">${z}</td>
            `;
            
            dataLog.insertBefore(row, dataLog.firstChild);
            
            // 限制記錄數量
            if (dataLog.children.length > 100) {
                dataLog.removeChild(dataLog.lastChild);
            }
        }

        // 中斷裝置連接
        async function disconnectFromDevice() {
            if (reader) {
                readLoop = false;
                try {
                    await reader.cancel();
                    reader.releaseLock();
                } catch (e) {
                    console.log('停止讀取時發生錯誤:', e);
                }
                reader = null;
            }
            
            if (port) {
                try {
                    await port.close();
                } catch (e) {
                    console.log('關閉連接時發生錯誤:', e);
                }
                port = null;
            }
            
            statusText.textContent = '已中斷連接';
            connectBtn.textContent = '連接接收端 Micro:bit';
        }

        // 清除日誌
        clearLogBtn.addEventListener('click', () => {
            dataLog.innerHTML = '';
        });

        // 檢測信號丟失
        setInterval(() => {
            if (port && lastDataTime > 0) {
                const now = new Date().getTime();
                const timeSinceLastData = now - lastDataTime;
                
                // 如果超過3秒未收到數據
                if (timeSinceLastData > 3000) {
                    statusText.textContent = `警告: ${Math.floor(timeSinceLastData/1000)}秒未收到數據`;
                    statusText.classList.add('text-red-500');
                } else {
                    statusText.classList.remove('text-red-500');
                }
            }
        }, 1000);
    </script>
</body>
</html>
