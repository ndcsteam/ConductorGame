<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>指揮家遊戲：節拍大師</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        success: '#4CAF50',
                        warning: '#FF9800',
                        danger: '#F44336',
                    },
                    animation: {
                        'conductor': 'conductor 1s ease-in-out infinite',
                        'pulse-slow': 'pulse 2s ease-in-out infinite',
                    },
                    keyframes: {
                        conductor: {
                            '0%, 100%': { transform: 'rotate(-5deg)' },
                            '50%': { transform: 'rotate(15deg)' },
                        },
                    }
                }
            }
        }
    </script>
    <style>
        .dark {
            --bg-main: #181818;
            --text-main: #f3f4f6;
            --bg-card: #2d2d2d;
        }
        
        .light {
            --bg-main: #ffffff;
            --text-main: #1f2937;
            --bg-card: #f9f9f9;
        }
        
        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .card {
            background-color: var(--bg-card);
        }

        .pulse {
            animation: pulse 0.8s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        .beat {
            animation: beat 0.5s ease-in-out;
        }
        
        @keyframes beat {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* 給指揮棒製作動畫 */
        .conductor-wand {
            transform-origin: bottom center;
        }

        .conducting {
            animation: conducting 0.5s ease-in-out;
        }

        @keyframes conducting {
            0% { transform: rotate(-10deg); }
            50% { transform: rotate(30deg); }
            100% { transform: rotate(-10deg); }
        }

        /* 進度條動畫 */
        @keyframes progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        .progress-animate {
            animation: progress linear forwards;
        }

        /* BPM 差異指示器 */
        .bpm-indicator {
            transition: left 0.3s ease-out;
        }

        /* 精度等級顯示 */
        .accuracy-text {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .accuracy-text.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-3xl">
        <h1 class="text-3xl font-bold mb-6 text-center">指揮家遊戲：節拍大師</h1>

        <!-- 遊戲狀態視窗 -->
        <div id="game-container" class="relative mb-8 p-6 rounded-lg bg-gray-100 dark:bg-gray-800 shadow-md card">
            <!-- 連接區塊 -->
            <div id="connection-panel" class="mb-6">
                <h2 class="text-xl font-semibold mb-4">連接您的指揮棒</h2>
                <p class="mb-4">連接 Micro:bit 接收器以開始遊戲（已設置接收頻道 250）</p>
                <button id="connect-button" class="bg-primary hover:bg-opacity-80 text-white font-medium py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50 transition">
                    連接 Micro:bit
                </button>
                <div id="connection-status" class="mt-4 text-sm font-medium">未連接</div>
            </div>

            <!-- 遊戲準備區塊 -->
            <div id="setup-panel" class="hidden mb-6 pb-6 border-b border-gray-300 dark:border-gray-700">
                <h2 class="text-xl font-semibold mb-4">選擇曲目</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <select id="music-select" class="w-full py-2 px-3 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 rounded text-base focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="game_start">遊戲開始音樂</option>
                        <option value="waltz">華爾滋舞曲 - 藍色多瑙河（目標 BPM: 60）</option>
                        <option value="march">進行曲 - 拉德斯基進行曲（目標 BPM: 108）</option>
                        <option value="symphony">交響曲 - 貝多芬第五交響曲（目標 BPM: 88）</option>
                    </select>
                    <div class="mt-2 text-xs text-gray-600 dark:text-gray-400">
                        BPM計算: 平均值計算，信號節流: 420ms
                    </div>
                    <button id="start-game-button" class="bg-success hover:bg-opacity-80 text-white font-medium py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-success focus:ring-opacity-50 transition">
                        開始遊戲
                    </button>
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400">
                    遊戲說明：聆聽音樂，使用您的 Micro:bit 指揮棒打拍子，嘗試保持音樂的節奏！
                </div>
            </div>

            <!-- 遊戲進行區塊 -->
            <div id="game-panel" class="hidden">
                <!-- 指揮動畫 -->
                <div class="flex justify-center items-center mb-6">
                    <div id="conductor-animation" class="relative h-48 w-48 flex justify-center items-center">
                        <!-- 指揮家圖示 -->
                        <div class="absolute bottom-0 w-full flex justify-center">
                            <div class="relative w-20 h-20 rounded-full bg-gray-300 dark:bg-gray-700 flex items-center justify-center">
                                <div class="w-16 h-16 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-800 dark:text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                </div>
                                <!-- 指揮棒 -->
                                <div id="conductor-wand" class="conductor-wand absolute h-24 w-2 bg-gray-800 dark:bg-gray-200 rounded-full" style="bottom: 50%; transform: rotate(-10deg);">
                                    <div class="absolute top-0 left-0 right-0 h-4 rounded-full bg-white dark:bg-gray-300"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 遊戲狀態信息 -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="p-4 rounded-lg bg-white dark:bg-gray-900 shadow text-center">
                        <div class="text-sm text-gray-500 dark:text-gray-400">當前 BPM</div>
                        <div id="current-bpm" class="text-3xl font-bold text-primary">--</div>
                    </div>
                    <div class="p-4 rounded-lg bg-white dark:bg-gray-900 shadow text-center">
                        <div class="text-sm text-gray-500 dark:text-gray-400">目標 BPM</div>
                        <div id="target-bpm" class="text-3xl font-bold text-success">--</div>
                    </div>
                </div>

                <!-- BPM 差異指示器 -->
                <div class="mb-6">
                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">BPM 差異：<span id="bpm-diff">--</span></div>
                    <div class="relative h-8 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="w-px h-full bg-gray-500 dark:bg-gray-400"></div>
                        </div>
                        <div id="bpm-indicator" class="bpm-indicator absolute top-0 bottom-0 w-6 h-6 bg-primary rounded-full transform -translate-x-1/2" style="left: 50%;"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                        <span>太慢</span>
                        <span>精準</span>
                        <span>太快</span>
                    </div>
                </div>

                <!-- 精準度 -->
                <div class="mb-6">
                    <div class="text-sm font-medium mb-1">精準度：<span id="accuracy-percent">0%</span></div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-2">
                        <div id="accuracy-bar" class="bg-primary h-2.5 rounded-full w-0 transition-all duration-300"></div>
                    </div>
                    <div id="accuracy-text" class="accuracy-text text-center py-2 font-medium text-lg transition-colors"></div>
                </div>

                <!-- 進度條 -->
                <div class="mb-4">
                    <div class="flex justify-between text-sm mb-1">
                        <div>進度</div>
                        <div id="time-display">00:00 / 00:00</div>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-primary h-2.5 rounded-full w-0 transition-all duration-300"></div>
                    </div>
                </div>

                <!-- 控制按鈕 -->
                <div class="flex justify-center mt-6">
                    <button id="stop-game-button" class="bg-danger hover:bg-opacity-80 text-white font-medium py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-danger focus:ring-opacity-50 transition">
                        結束遊戲
                    </button>
                </div>
            </div>

            <!-- 遊戲結果區塊 -->
            <div id="result-panel" class="hidden">
                <h2 class="text-xl font-semibold mb-4 text-center">遊戲結果</h2>
                <div class="p-6 rounded-lg bg-white dark:bg-gray-900 shadow-md text-center mb-6">
                    <div id="result-title" class="text-2xl font-bold mb-4">精準指揮家！</div>
                    <div id="result-score" class="text-4xl font-bold text-primary mb-6">96%</div>
                    <div id="result-details" class="grid grid-cols-2 gap-4 mb-6 max-w-sm mx-auto">
                        <div class="text-left">
                            <div class="text-sm text-gray-500 dark:text-gray-400">目標 BPM</div>
                            <div id="result-target-bpm" class="text-lg font-medium">60</div>
                        </div>
                        <div class="text-left">
                            <div class="text-sm text-gray-500 dark:text-gray-400">平均 BPM</div>
                            <div id="result-average-bpm" class="text-lg font-medium">62</div>
                        </div>
                        <div class="text-left">
                            <div class="text-sm text-gray-500 dark:text-gray-400">精準節拍次數</div>
                            <div id="result-accurate-beats" class="text-lg font-medium">45</div>
                        </div>
                        <div class="text-left">
                            <div class="text-sm text-gray-500 dark:text-gray-400">總節拍次數</div>
                            <div id="result-total-beats" class="text-lg font-medium">48</div>
                        </div>
                    </div>
                    <div id="result-comment" class="text-gray-600 dark:text-gray-400 mb-6">
                        您展現了出色的指揮技巧，持續保持穩定的節奏！
                    </div>
                    <div class="flex justify-center">
                        <button id="play-again-button" class="bg-primary hover:bg-opacity-80 text-white font-medium py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50 transition">
                            再玩一次
                        </button>
                    </div>
                </div>
            </div>

            <!-- 音樂播放器（隱藏） -->
            <audio id="game-audio" class="hidden"></audio>
        </div>

        <div class="text-sm text-gray-600 dark:text-gray-400 mt-8">
            <h3 class="font-semibold mb-2">遊戲說明：</h3>
            <ol class="list-decimal pl-5 space-y-1">
                <li>將接收 Micro:bit 透過 USB 連接至此裝置</li>
                <li>將發送 Micro:bit 當作您的指揮棒</li>
                <li>選擇音樂曲目並開始遊戲</li>
                <li>聆聽音樂，使用指揮棒打拍子，嘗試達到目標 BPM</li>
                <li>精準度越高，得分越高！</li>
            </ol>
            <p class="mt-2">
                <span class="font-semibold">提示：</span> 指揮棒需明顯加速才能被系統檢測到。每次指揮動作應為明確的下揮動作。
            </p>
        </div>
    </div>

    <script>
        // 檢測深色模式偏好
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // 音樂資源設定
        const MUSIC_RESOURCES = {
            game_start: {
                url: 'https://cdn.jsdelivr.net/gh/iGitScor/Music-samples/wav/bubbles.wav',
                duration: 10,
                bpm: 0, // 非遊戲音樂
                title: '遊戲開始音樂'
            },
            waltz: {
                url: './audio/TheBlueDanube.mp3',
                duration: 30,
                bpm: 60,
                title: '華爾滋舞曲 - 藍色多瑙河',
                comment: '穩定的三拍子節奏，慢速優雅的舞曲風格'
            },
            march: {
                url: 'https://cdn.jsdelivr.net/gh/iGitScor/Music-samples/wav/littleidea.wav',
                duration: 30,
                bpm: 108,
                title: '進行曲 - 拉德斯基進行曲',
                comment: '活力充沛的二拍子節奏，適合行進和頒獎典禮'
            },
            symphony: {
                url: 'https://cdn.jsdelivr.net/gh/iGitScor/Music-samples/wav/ukulele.wav',
                duration: 30,
                bpm: 88,
                title: '交響曲 - 貝多芬第五交響曲',
                comment: '雄偉的四拍子節奏，著名的"命運之門"動機'
            }
        };

        // 全局變數
        let port;
        let reader;
        let reading = false;
        let textDecoder = new TextDecoder();
        let accelerationCount = 0;
        
        // BPM 計算相關變數
        let timestamps = [];
        let lastTimestamp = 0;
        let bpm = 0;
        let lastInterval = 0;
        
        // 信號節流變數
        let lastSignalTime = 0;
        const throttleTime = 420; // 固定為 420 毫秒
        let isProcessing = false;
        
        // 遊戲相關變數
        let gameActive = false;
        let gameStartTime = 0;
        let currentMusic = null;
        let targetBpm = 0;
        let gameTimer = null;
        let gameData = {
            totalBeats: 0,
            accurateBeats: 0, // BPM差異 < 5 的準確節拍
            bpmReadings: []
        };
        let accuracyTimeoutId = null;

        // DOM 元素
        const connectButton = document.getElementById('connect-button');
        const connectionStatus = document.getElementById('connection-status');
        const connectionPanel = document.getElementById('connection-panel');
        const setupPanel = document.getElementById('setup-panel');
        const gamePanel = document.getElementById('game-panel');
        const resultPanel = document.getElementById('result-panel');
        const musicSelect = document.getElementById('music-select');
        const startGameButton = document.getElementById('start-game-button');
        const stopGameButton = document.getElementById('stop-game-button');
        const playAgainButton = document.getElementById('play-again-button');
        const gameAudio = document.getElementById('game-audio');
        const currentBpmDisplay = document.getElementById('current-bpm');
        const targetBpmDisplay = document.getElementById('target-bpm');
        const bpmDiffDisplay = document.getElementById('bpm-diff');
        const bpmIndicator = document.getElementById('bpm-indicator');
        const accuracyBar = document.getElementById('accuracy-bar');
        const accuracyPercent = document.getElementById('accuracy-percent');
        const accuracyText = document.getElementById('accuracy-text');
        const progressBar = document.getElementById('progress-bar');
        const timeDisplay = document.getElementById('time-display');
        const conductorWand = document.getElementById('conductor-wand');

        // 檢查 Web Serial API 支援
        if (!('serial' in navigator)) {
            connectionStatus.textContent = '您的瀏覽器不支援 Web Serial API。請使用 Chrome 或 Edge 瀏覽器。';
            connectionStatus.classList.add('text-red-500');
            connectButton.disabled = true;
            connectButton.classList.add('opacity-50', 'cursor-not-allowed');
        }

        // 連接按鈕點擊事件
        connectButton.addEventListener('click', async () => {
            try {
                // 請求 serial port
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                
                connectionStatus.textContent = '已連接 Micro:bit 指揮棒';
                connectionStatus.classList.add('text-green-500');
                connectButton.textContent = '已連接';
                connectButton.classList.add('bg-green-500');
                connectButton.disabled = true;
                
                // 顯示設置面板
                setupPanel.classList.remove('hidden');
                
                // 開始讀取數據
                readSerialData();
                
            } catch (error) {
                console.error('連接錯誤:', error);
                connectionStatus.textContent = '連接失敗: ' + (error.message || '未知錯誤');
                connectionStatus.classList.add('text-red-500');
            }
        });

        // 開始遊戲按鈕
        startGameButton.addEventListener('click', startGame);
        
        // 停止遊戲按鈕
        stopGameButton.addEventListener('click', endGame);
        
        // 再玩一次按鈕
        playAgainButton.addEventListener('click', resetGame);

        // 讀取串口數據
        async function readSerialData() {
            if (reading) return;
            
            reading = true;
            reader = port.readable.getReader();
            
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    
                    if (done) {
                        break;
                    }
                    
                    // 處理接收到的數據
                    processData(value);
                }
            } catch (error) {
                console.error('讀取錯誤:', error);
            } finally {
                reader.releaseLock();
                reading = false;
                
                // 如果連接還存在，則嘗試再次讀取
                if (port && port.readable) {
                    setTimeout(readSerialData, 100);
                } else {
                    connectionStatus.textContent = '連接已斷開';
                    connectionStatus.classList.remove('text-green-500');
                    connectionStatus.classList.add('text-red-500');
                    connectButton.textContent = '重新連接';
                    connectButton.classList.remove('bg-green-500');
                    connectButton.disabled = false;
                    
                    // 如果遊戲正在進行，則結束遊戲
                    if (gameActive) {
                        endGame();
                    }
                }
            }
        }

        // 處理接收到的數據
        function processData(data) {
            const text = textDecoder.decode(data).trim();
            console.log('接收到數據:', text);
            
            // 檢查是否接收到 "b" 信號
            if (text.includes('b')) {
                // 節流處理 - 忽略節流時間內的連續信號
                const now = performance.now();
                if (now - lastSignalTime < throttleTime) {
                    console.log(`信號節流: 間隔 ${Math.round(now - lastSignalTime)}ms < ${throttleTime}ms, 忽略`);
                    return;
                }
                
                // 如果正在處理中，也忽略
                if (isProcessing) {
                    return;
                }
                
                isProcessing = true;
                lastSignalTime = now;
                
                // 處理加速度檢測
                if (gameActive) {
                    conductorBeat();
                }
                
                // 設定短時間後重置處理標誌，以確保信號處理完畢
                setTimeout(() => {
                    isProcessing = false;
                }, 50);
            }
        }

        // 開始遊戲
        function startGame() {
            const musicKey = musicSelect.value;
            currentMusic = MUSIC_RESOURCES[musicKey];
            targetBpm = currentMusic.bpm;
            
            // 不是遊戲音樂則返回選擇界面
            if (targetBpm === 0) {
                gameAudio.src = currentMusic.url;
                gameAudio.play();
                return;
            }
            
            // 重置遊戲數據
            gameData = {
                totalBeats: 0,
                accurateBeats: 0,
                bpmReadings: []
            };
            
            // 設置音頻並播放
            gameAudio.src = currentMusic.url;
            gameAudio.onloadedmetadata = () => {
                // 更新界面
                connectionPanel.classList.add('hidden');
                setupPanel.classList.add('hidden');
                gamePanel.classList.remove('hidden');
                
                // 設置目標 BPM 顯示
                targetBpmDisplay.textContent = targetBpm;
                currentBpmDisplay.textContent = '--';
                bpmDiffDisplay.textContent = '--';
                
                // 重置 BPM 指示器
                bpmIndicator.style.left = '50%';
                
                // 重置精準度
                accuracyBar.style.width = '0%';
                accuracyPercent.textContent = '0%';
                
                // 重置進度條
                updateProgressBar(0);
                
                // 開始遊戲
                gameActive = true;
                gameStartTime = performance.now();
                gameAudio.play();
                
                // 設置遊戲計時器
                const duration = gameAudio.duration;
                updateTimeDisplay(0, duration);
                
                // 設置進度更新定時器
                gameTimer = setInterval(() => {
                    const currentTime = gameAudio.currentTime;
                    const duration = gameAudio.duration;
                    
                    updateProgressBar(currentTime / duration * 100);
                    updateTimeDisplay(currentTime, duration);
                    
                    // 檢查遊戲是否結束
                    if (currentTime >= duration) {
                        endGame();
                    }
                }, 100);
            };
        }

        // 計算 BPM - 平均法
        function calculateAverageBPM() {
            if (timestamps.length < 2) return 0;
            
            // 計算時間間隔（以毫秒為單位）
            const intervals = [];
            for (let i = 1; i < timestamps.length; i++) {
                intervals.push(timestamps[i] - timestamps[i - 1]);
            }
            
            // 計算平均間隔
            const averageInterval = intervals.reduce((sum, interval) => sum + interval, 0) / intervals.length;
            
            // 轉換為 BPM（每分鐘節拍數）
            return Math.round(60000 / averageInterval);
        }
        
        // 指揮動作
        function conductorBeat() {
            accelerationCount++;
            const now = performance.now();
            
            // 添加指揮棒動畫
            conductorWand.classList.add('conducting');
            setTimeout(() => {
                conductorWand.classList.remove('conducting');
            }, 400);
            
            // 記錄時間戳以計算平均 BPM
            timestamps.push(now);
            
            // 保持固定數量的樣本 (最近5個)
            if (timestamps.length > 5) {
                timestamps.shift();
            }
            
            let newBpm = 0;
            let interval = 0;
            
            if (lastTimestamp) {
                interval = now - lastTimestamp;
                lastInterval = interval;
                
                // 只有在合理範圍內的間隔才計算 BPM（300-2000ms 大致對應 30-200 BPM）
                if (interval >= 300 && interval <= 2000) {
                    // 使用平均值計算 BPM
                    newBpm = calculateAverageBPM();
                    
                    // 更新遊戲數據
                    gameData.totalBeats++;
                    gameData.bpmReadings.push(newBpm);
                    
                    // 計算與目標 BPM 的差異
                    const bpmDiff = newBpm - targetBpm;
                    const diffPercent = Math.min(Math.abs(bpmDiff) / targetBpm, 1);
                    
                    // 更新 BPM 差異顯示
                    if (bpmDiff > 0) {
                        bpmDiffDisplay.textContent = `+${bpmDiff} (太快)`;
                    } else if (bpmDiff < 0) {
                        bpmDiffDisplay.textContent = `${bpmDiff} (太慢)`;
                    } else {
                        bpmDiffDisplay.textContent = `精準!`;
                    }
                    
                    // 更新 BPM 指示器位置
                    // 從 0% (太慢) 到 100% (太快)，50% 是精準
                    const indicatorPos = Math.max(0, Math.min(100, 50 + (bpmDiff / targetBpm * 50)));
                    bpmIndicator.style.left = `${indicatorPos}%`;
                    
                    // 更新精準度
                    if (Math.abs(bpmDiff) <= 5) {
                        gameData.accurateBeats++;
                        showAccuracyFeedback('精準！', 'text-success');
                    } else if (Math.abs(bpmDiff) <= 10) {
                        showAccuracyFeedback('不錯', 'text-warning');
                    } else {
                        showAccuracyFeedback('調整節奏', 'text-danger');
                    }
                    
                    // 計算並更新精準度百分比
                    const accuracy = (gameData.accurateBeats / gameData.totalBeats * 100).toFixed(0);
                    accuracyBar.style.width = `${accuracy}%`;
                    accuracyPercent.textContent = `${accuracy}%`;
                    
                    // 更新當前 BPM 顯示
                    currentBpmDisplay.textContent = newBpm;
                    currentBpmDisplay.classList.add('beat');
                    setTimeout(() => {
                        currentBpmDisplay.classList.remove('beat');
                    }, 500);
                }
            }
            
            // 更新最後一次時間戳
            lastTimestamp = now;
        }

        // 顯示精準度反饋
        function showAccuracyFeedback(text, colorClass) {
            // 清除之前的 timeout
            if (accuracyTimeoutId) {
                clearTimeout(accuracyTimeoutId);
            }
            
            // 移除之前的顏色類並添加新類
            accuracyText.className = 'accuracy-text transition-colors ' + colorClass;
            accuracyText.textContent = text;
            accuracyText.classList.add('show');
            
            // 設置淡出
            accuracyTimeoutId = setTimeout(() => {
                accuracyText.classList.remove('show');
            }, 1500);
        }

        // 更新進度條
        function updateProgressBar(percent) {
            progressBar.style.width = `${percent}%`;
        }

        // 更新時間顯示
        function updateTimeDisplay(currentTime, duration) {
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };
            
            timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
        }

        // 結束遊戲
        function endGame() {
            // 停止音樂和計時器
            gameAudio.pause();
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }
            
            // 標記遊戲結束
            gameActive = false;
            
            // 更新界面
            gamePanel.classList.add('hidden');
            resultPanel.classList.remove('hidden');
            
            // 計算遊戲結果
            const totalBeats = gameData.totalBeats;
            const accurateBeats = gameData.accurateBeats;
            const accuracy = totalBeats > 0 ? (accurateBeats / totalBeats * 100).toFixed(0) : 0;
            
            // 計算平均 BPM
            let averageBpm = 0;
            if (gameData.bpmReadings.length > 0) {
                averageBpm = Math.round(
                    gameData.bpmReadings.reduce((sum, bpm) => sum + bpm, 0) / gameData.bpmReadings.length
                );
            }
            
            // 設置結果標題和評級
            let resultTitle = '';
            let resultComment = '';
            
            if (accuracy >= 90) {
                resultTitle = '一流指揮家！';
                resultComment = '您展現了精湛的指揮技巧，節奏控制幾乎完美！';
            } else if (accuracy >= 70) {
                resultTitle = '優秀指揮家！';
                resultComment = '您的指揮相當不錯，只需稍微調整節奏！';
            } else if (accuracy >= 50) {
                resultTitle = '有潛力的指揮家';
                resultComment = '您有基本的節奏感，繼續練習能更好！';
            } else {
                resultTitle = '初學指揮家';
                resultComment = '節奏控制需要更多練習，多聆聽音樂會有所幫助！';
            }
            
            // 更新結果面板
            document.getElementById('result-title').textContent = resultTitle;
            document.getElementById('result-score').textContent = `${accuracy}%`;
            document.getElementById('result-target-bpm').textContent = targetBpm;
            document.getElementById('result-average-bpm').textContent = averageBpm || '--';
            document.getElementById('result-accurate-beats').textContent = accurateBeats;
            document.getElementById('result-total-beats').textContent = totalBeats;
            document.getElementById('result-comment').textContent = resultComment;
        }

        // 重置遊戲
        function resetGame() {
            resultPanel.classList.add('hidden');
            setupPanel.classList.remove('hidden');
            
            // 重置遊戲數據
            lastTimestamp = 0;
            accelerationCount = 0;
            gameData = {
                totalBeats: 0,
                accurateBeats: 0,
                bpmReadings: []
            };
        }
    </script>
</body>
</html>
