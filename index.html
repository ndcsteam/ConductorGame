<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro:bit XYZ 座標讀取器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                colors: {
                    primary: '#5D5CDE',
                },
            },
        },
    }
    </script>
    <style>
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .chart-bar {
            position: absolute;
            bottom: 0;
            width: 30%;
            transition: height 0.2s ease-out;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .x-bar {
            left: 5%;
            background-color: #ef4444;
        }
        .y-bar {
            left: 35%;
            background-color: #22c55e;
        }
        .z-bar {
            left: 65%;
            background-color: #3b82f6;
        }
        .dark .chart-container {
            background-color: #1e1e1e;
        }
        .dark .value-display {
            background-color: #2d2d2d;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <h1 class="text-3xl font-bold mb-6 text-center text-primary">Micro:bit XYZ 座標讀取器</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-6 shadow-md">
                <h2 class="text-xl font-semibold mb-4">連接與控制</h2>
                
                <div class="mb-4">
                    <button id="connectBtn" class="w-full bg-primary hover:bg-opacity-90 text-white font-medium py-2 px-4 rounded-md transition">
                        連接 Micro:bit
                    </button>
                </div>
                
                <div id="statusContainer" class="mb-4 p-3 bg-gray-200 dark:bg-gray-700 rounded-md">
                    <p id="statusText">尚未連接</p>
                </div>
                
                <div class="flex flex-col space-y-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="autoUpdate" class="w-5 h-5 text-primary rounded focus:ring-primary" checked>
                        <span class="ml-2">自動更新數據</span>
                    </label>
                    
                    <div class="flex items-center">
                        <label for="updateInterval" class="mr-2">更新間隔 (毫秒):</label>
                        <input type="number" id="updateInterval" min="50" max="5000" step="50" value="100" 
                               class="w-24 py-1 px-2 text-base border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700">
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-6 shadow-md">
                <h2 class="text-xl font-semibold mb-4">XYZ 座標數據</h2>
                
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="value-display bg-gray-200 dark:bg-gray-700 rounded-md p-3 text-center">
                        <div class="text-red-500 font-bold text-lg">X</div>
                        <div id="xValue" class="text-2xl font-mono">0</div>
                    </div>
                    <div class="value-display bg-gray-200 dark:bg-gray-700 rounded-md p-3 text-center">
                        <div class="text-green-500 font-bold text-lg">Y</div>
                        <div id="yValue" class="text-2xl font-mono">0</div>
                    </div>
                    <div class="value-display bg-gray-200 dark:bg-gray-700 rounded-md p-3 text-center">
                        <div class="text-blue-500 font-bold text-lg">Z</div>
                        <div id="zValue" class="text-2xl font-mono">0</div>
                    </div>
                </div>
                
                <div class="chart-container bg-gray-200 rounded-md p-2">
                    <div id="xBar" class="chart-bar x-bar" style="height: 50%;"></div>
                    <div id="yBar" class="chart-bar y-bar" style="height: 50%;"></div>
                    <div id="zBar" class="chart-bar z-bar" style="height: 50%;"></div>
                    <div class="absolute bottom-0 left-0 w-full border-t border-gray-400 dark:border-gray-600"></div>
                </div>
                
                <div class="flex justify-between mt-2 px-2 text-sm">
                    <div class="text-red-500">X</div>
                    <div class="text-green-500">Y</div>
                    <div class="text-blue-500">Z</div>
                </div>
            </div>
        </div>
        
        <div class="mt-6 bg-gray-100 dark:bg-gray-800 rounded-lg p-6 shadow-md">
            <h2 class="text-xl font-semibold mb-4">數據記錄</h2>
            <div class="overflow-auto max-h-60">
                <table class="min-w-full">
                    <thead>
                        <tr class="bg-gray-200 dark:bg-gray-700">
                            <th class="py-2 px-4 text-left">時間</th>
                            <th class="py-2 px-4 text-left">X</th>
                            <th class="py-2 px-4 text-left">Y</th>
                            <th class="py-2 px-4 text-left">Z</th>
                        </tr>
                    </thead>
                    <tbody id="dataLog">
                        <!-- 數據紀錄將會動態添加在這裡 -->
                    </tbody>
                </table>
            </div>
            <div class="mt-3 flex justify-end">
                <button id="clearLogBtn" class="bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 py-1 px-3 rounded-md">
                    清除記錄
                </button>
            </div>
        </div>
    </div>

    <script>
        // 檢測暗色模式
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Micro:bit 服務和特性 UUID
        const ACCELEROMETER_SERVICE_UUID = 'e95d0753-251d-470a-a062-fa1922dfa9a8';
        const ACCELEROMETER_DATA_UUID = 'e95dca4b-251d-470a-a062-fa1922dfa9a8';
        const ACCELEROMETER_PERIOD_UUID = 'e95dfb24-251d-470a-a062-fa1922dfa9a8';

        // 全域變數
        let microbitDevice = null;
        let accelerometerCharacteristic = null;
        let notificationsEnabled = false;
        let updateIntervalId = null;

        // DOM 元素
        const connectBtn = document.getElementById('connectBtn');
        const statusText = document.getElementById('statusText');
        const autoUpdateCheckbox = document.getElementById('autoUpdate');
        const updateIntervalInput = document.getElementById('updateInterval');
        const xValue = document.getElementById('xValue');
        const yValue = document.getElementById('yValue');
        const zValue = document.getElementById('zValue');
        const xBar = document.getElementById('xBar');
        const yBar = document.getElementById('yBar');
        const zBar = document.getElementById('zBar');
        const dataLog = document.getElementById('dataLog');
        const clearLogBtn = document.getElementById('clearLogBtn');

        // 連接到 Micro:bit
        connectBtn.addEventListener('click', async () => {
            try {
                if (microbitDevice && microbitDevice.gatt.connected) {
                    await disconnectFromDevice();
                    return;
                }

                statusText.textContent = '正在尋找 Micro:bit 裝置...';
                
                // 檢查瀏覽器支援
                if (!navigator.bluetooth) {
                    throw new Error('您的瀏覽器不支援 Web Bluetooth API。請使用 Chrome、Edge 或其他支援的瀏覽器。');
                }
                
                // 請求裝置
                microbitDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'BBC micro:bit' }],
                    optionalServices: [ACCELEROMETER_SERVICE_UUID]
                });
                
                statusText.textContent = '連接中...';
                
                // 連接到 GATT 伺服器
                const server = await microbitDevice.gatt.connect();
                
                // 獲取加速度計服務
                const service = await server.getPrimaryService(ACCELEROMETER_SERVICE_UUID);
                
                // 獲取加速度計特性
                accelerometerCharacteristic = await service.getCharacteristic(ACCELEROMETER_DATA_UUID);
                
                // 設置加速度計頻率 (10 = 100ms)
                const periodCharacteristic = await service.getCharacteristic(ACCELEROMETER_PERIOD_UUID);
                const period = new Uint8Array([10]);
                await periodCharacteristic.writeValue(period);
                
                // 啟動通知
                await accelerometerCharacteristic.startNotifications();
                accelerometerCharacteristic.addEventListener('characteristicvaluechanged', handleAccelerometerData);
                notificationsEnabled = true;
                
                statusText.textContent = '已連接';
                connectBtn.textContent = '中斷連接';
                
                // 設置間隔自動更新
                if (autoUpdateCheckbox.checked) {
                    startAutoUpdate();
                }
                
                // 監聽裝置中斷連接事件
                microbitDevice.addEventListener('gattserverdisconnected', handleDisconnection);
                
            } catch (error) {
                console.error('連接錯誤:', error);
                statusText.textContent = `錯誤: ${error.message}`;
                await disconnectFromDevice();
            }
        });

        // 處理加速度計數據
        function handleAccelerometerData(event) {
            const value = event.target.value;
            const x = value.getInt16(0, true);
            const y = value.getInt16(2, true);
            const z = value.getInt16(4, true);
            
            updateDisplay(x, y, z);
            logData(x, y, z);
        }

        // 更新顯示
        function updateDisplay(x, y, z) {
            xValue.textContent = x;
            yValue.textContent = y;
            zValue.textContent = z;
            
            // 更新圖表，範圍從 -2000 到 2000，轉換為 0-100%
            const xPercent = ((x + 2000) / 4000) * 100;
            const yPercent = ((y + 2000) / 4000) * 100;
            const zPercent = ((z + 2000) / 4000) * 100;
            
            xBar.style.height = `${Math.min(Math.max(xPercent, 0), 100)}%`;
            yBar.style.height = `${Math.min(Math.max(yPercent, 0), 100)}%`;
            zBar.style.height = `${Math.min(Math.max(zPercent, 0), 100)}%`;
        }

        // 記錄數據
        function logData(x, y, z) {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="py-1 px-4 border-t border-gray-200 dark:border-gray-700">${timeString}</td>
                <td class="py-1 px-4 border-t border-gray-200 dark:border-gray-700 text-red-500">${x}</td>
                <td class="py-1 px-4 border-t border-gray-200 dark:border-gray-700 text-green-500">${y}</td>
                <td class="py-1 px-4 border-t border-gray-200 dark:border-gray-700 text-blue-500">${z}</td>
            `;
            
            dataLog.insertBefore(row, dataLog.firstChild);
            
            // 限制記錄數量
            if (dataLog.children.length > 100) {
                dataLog.removeChild(dataLog.lastChild);
            }
        }

        // 中斷裝置連接
        async function disconnectFromDevice() {
            if (updateIntervalId) {
                clearInterval(updateIntervalId);
                updateIntervalId = null;
            }
            
            if (accelerometerCharacteristic && notificationsEnabled) {
                try {
                    await accelerometerCharacteristic.stopNotifications();
                    accelerometerCharacteristic.removeEventListener('characteristicvaluechanged', handleAccelerometerData);
                    notificationsEnabled = false;
                } catch (e) {
                    console.log('停止通知時發生錯誤:', e);
                }
            }
            
            if (microbitDevice && microbitDevice.gatt.connected) {
                try {
                    microbitDevice.removeEventListener('gattserverdisconnected', handleDisconnection);
                    await microbitDevice.gatt.disconnect();
                } catch (e) {
                    console.log('中斷連接時發生錯誤:', e);
                }
            }
            
            microbitDevice = null;
            accelerometerCharacteristic = null;
            statusText.textContent = '已中斷連接';
            connectBtn.textContent = '連接 Micro:bit';
        }

        // 處理意外中斷連接
        function handleDisconnection() {
            console.log('裝置已中斷連接');
            statusText.textContent = '裝置已中斷連接';
            connectBtn.textContent = '連接 Micro:bit';
            
            if (updateIntervalId) {
                clearInterval(updateIntervalId);
                updateIntervalId = null;
            }
            
            microbitDevice = null;
            accelerometerCharacteristic = null;
            notificationsEnabled = false;
        }

        // 自動更新設置
        function startAutoUpdate() {
            if (updateIntervalId) {
                clearInterval(updateIntervalId);
            }
            
            const interval = parseInt(updateIntervalInput.value);
            updateIntervalId = setInterval(async () => {
                if (accelerometerCharacteristic && microbitDevice && microbitDevice.gatt.connected) {
                    try {
                        // 讀取最新數據
                        const value = await accelerometerCharacteristic.readValue();
                        const x = value.getInt16(0, true);
                        const y = value.getInt16(2, true);
                        const z = value.getInt16(4, true);
                        
                        updateDisplay(x, y, z);
                        logData(x, y, z);
                    } catch (error) {
                        console.error('讀取數據錯誤:', error);
                    }
                }
            }, interval);
        }

        // 自動更新切換
        autoUpdateCheckbox.addEventListener('change', () => {
            if (autoUpdateCheckbox.checked && microbitDevice && microbitDevice.gatt.connected) {
                startAutoUpdate();
            } else if (updateIntervalId) {
                clearInterval(updateIntervalId);
                updateIntervalId = null;
            }
        });

        // 更新間隔變更
        updateIntervalInput.addEventListener('change', () => {
            if (autoUpdateCheckbox.checked && microbitDevice && microbitDevice.gatt.connected) {
                startAutoUpdate();
            }
        });

        // 清除日誌
        clearLogBtn.addEventListener('click', () => {
            dataLog.innerHTML = '';
        });
    </script>
</body>
</html>
