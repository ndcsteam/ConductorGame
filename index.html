<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>指揮家遊戲：節拍大師</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#d4af37', // 金色
                        secondary: '#8b4513', // 深棕色
                        accent: '#964B00', // 銅色
                        success: '#4CAF50',
                        warning: '#FF9800',
                        danger: '#F44336',
                        conductor: {
                            dark: '#121212',
                            medium: '#1a1a1a',
                            light: '#222222',
                            gold: '#d4af37',
                            copper: '#964B00',
                            velvet: '#5D0A0A',
                            wood: '#5d4037',
                        }
                    },
                    fontFamily: {
                        'sans': ['Noto Sans TC', 'sans-serif'],
                    },
                    animation: {
                        'spotlight': 'spotlight 5s ease-in-out infinite',
                        'glow': 'glow 2s ease-in-out infinite',
                        'fade-in': 'fadeIn 1s ease-out forwards',
                        'fade-out': 'fadeOut 1s ease-out forwards',
                        'conductor': 'conductor 1s ease-in-out infinite',
                        'float-slow': 'float 20s ease-in-out infinite',
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        spotlight: {
                            '0%': { opacity: 0.5, transform: 'translate(-30%, -30%) scale(0.8)' },
                            '50%': { opacity: 0.8, transform: 'translate(-25%, -25%) scale(1)' },
                            '100%': { opacity: 0.5, transform: 'translate(-30%, -30%) scale(0.8)' },
                        },
                        glow: {
                            '0%, 100%': { filter: 'brightness(1)' },
                            '50%': { filter: 'brightness(1.2)' },
                        },
                        fadeIn: {
                            '0%': { opacity: 0 },
                            '100%': { opacity: 1 },
                        },
                        fadeOut: {
                            '0%': { opacity: 1 },
                            '100%': { opacity: 0 },
                        },
                        conductor: {
                            '0%, 100%': { transform: 'rotate(-5deg)' },
                            '50%': { transform: 'rotate(15deg)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' },
                        },
                        pulse: {
                            '0%, 100%': { opacity: 1 },
                            '50%': { opacity: 0.7 },
                        }
                    },
                    backgroundImage: {
                        'stage-texture': "url('data:image/svg+xml,%3Csvg width=\"100\" height=\"100\" viewBox=\"0 0 100 100\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cpath d=\"M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z\" fill=\"%239C92AC\" fill-opacity=\"0.05\" fill-rule=\"evenodd\"/%3E%3C/svg%3E')",
                    }
                }
            }
        }
    </script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Noto Sans TC', sans-serif;
            position: relative;
            overflow-x: hidden;
        }
        
        /* 舞台和聚光燈效果 */
        .concert-hall {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 30%, rgba(212, 175, 55, 0.08) 0%, rgba(212, 175, 55, 0) 50%),
                linear-gradient(180deg, #121212 0%, #0a0a0a 100%);
            z-index: -2;
        }
        
        .spotlights {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .spotlight {
            position: absolute;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.15) 0%, rgba(212, 175, 55, 0) 70%);
            width: 100%;
            height: 100%;
            opacity: 0;
            transform-origin: center;
        }
        
        .spotlight-1 {
            top: 0;
            left: 0;
            animation: spotlight-1 15s ease-in-out infinite;
        }
        
        .spotlight-2 {
            top: 0;
            right: 0;
            animation: spotlight-2 18s ease-in-out infinite 2s;
        }
        
        .spotlight-3 {
            bottom: 0;
            left: 30%;
            animation: spotlight-3 20s ease-in-out infinite 5s;
        }
        
        @keyframes spotlight-1 {
            0%, 100% { opacity: 0.4; transform: scale(0.8); }
            50% { opacity: 0.6; transform: scale(1); }
        }
        
        @keyframes spotlight-2 {
            0%, 100% { opacity: 0.3; transform: scale(0.7) rotate(-15deg); }
            50% { opacity: 0.5; transform: scale(0.9) rotate(-5deg); }
        }
        
        @keyframes spotlight-3 {
            0%, 100% { opacity: 0.3; transform: scale(0.7) rotate(10deg); }
            50% { opacity: 0.5; transform: scale(0.9) rotate(5deg); }
        }
        
        /* 舞台紋理 */
        .stage-texture {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml,%3Csvg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z" fill="%239C92AC" fill-opacity="0.05" fill-rule="evenodd"/%3E%3C/svg%3E');
            opacity: 0.12;
            z-index: -1;
        }
        
        /* 指揮台效果 */
        .conductor-stage {
            background: linear-gradient(180deg, rgba(93, 64, 55, 0.4) 0%, rgba(93, 64, 55, 0.25) 100%);
            border: 1px solid rgba(212, 175, 55, 0.1);
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5),
                        inset 0 0 15px rgba(212, 175, 55, 0.1);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .conductor-stage::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.05) 0%, rgba(212, 175, 55, 0) 50%);
            pointer-events: none;
        }
        
        /* 旋律波浪 */
        .melody-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0) 0%, rgba(212, 175, 55, 0.2) 50%, rgba(212, 175, 55, 0) 100%);
            filter: blur(2px);
            opacity: 0;
            transform: translateY(10px);
            z-index: 1;
        }
        
        .melody-wave.active {
            animation: wave 1.2s ease-out;
        }
        
        @keyframes wave {
            0% { opacity: 0; transform: translateY(10px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; width: 100%; }
            100% { opacity: 0; width: 100%; transform: translateY(0); }
        }
        
        /* 金色裝飾線 */
        .gold-divider {
            height: 1px;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0) 0%, rgba(212, 175, 55, 0.5) 50%, rgba(212, 175, 55, 0) 100%);
            margin: 12px 0;
        }
        
        /* 優雅按鈕 */
        .elegant-button {
            background: linear-gradient(to bottom, rgba(212, 175, 55, 0.2), rgba(150, 75, 0, 0.2));
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: rgba(212, 175, 55, 0.9);
            letter-spacing: 0.05em;
            padding: 8px 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border-radius: 4px;
        }
        
        .elegant-button:hover {
            background: linear-gradient(to bottom, rgba(212, 175, 55, 0.3), rgba(150, 75, 0, 0.3));
            border-color: rgba(212, 175, 55, 0.5);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }
        
        .elegant-button:active {
            transform: translateY(1px);
        }
        
        .elegant-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        
        .elegant-button:hover::after {
            left: 100%;
        }
        
        /* Cover Page 特效 */
        .cover-page {
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-image: url('./images/stage.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        /* 背景暗化覆蓋層 */
        .cover-page::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 0;
        }
        
        /* 確保內容顯示在覆蓋層上方 */
        .cover-page > * {
            position: relative;
            z-index: 1;
        }
        
        .cover-title {
            position: relative;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
            letter-spacing: 0.1em;
        }
        
        .cover-subtitle {
            position: relative;
            letter-spacing: 0.05em;
            opacity: 0.8;
        }
        
        .grand-button {
            background: linear-gradient(to bottom, rgba(212, 175, 55, 0.3), rgba(150, 75, 0, 0.3));
            border: 1px solid rgba(212, 175, 55, 0.5);
            color: rgba(255, 255, 255, 0.95);
            font-weight: 500;
            letter-spacing: 0.1em;
            padding: 12px 28px;
            font-size: 1.2rem;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            border-radius: 4px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .grand-button:hover {
            background: linear-gradient(to bottom, rgba(212, 175, 55, 0.4), rgba(150, 75, 0, 0.4));
            border-color: rgba(212, 175, 55, 0.7);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4), 0 0 15px rgba(212, 175, 55, 0.4);
            transform: translateY(-2px);
        }
        
        .grand-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .grand-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: 0.7s;
        }
        
        .grand-button:hover::after {
            left: 100%;
        }
        
        .orchestra-image {
            position: relative;
            width: 90%;
            max-width: 600px;
            margin: 0 auto;
            opacity: 0.7;
            filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.2));
        }
        
        .floating-note {
            position: absolute;
            color: rgba(212, 175, 55, 0.3);
            font-size: 2rem;
            filter: drop-shadow(0 0 8px rgba(212, 175, 55, 0.2));
            pointer-events: none;
            animation-duration: calc(15s + (var(--note-index) * 5s));
            animation-delay: calc(var(--note-index) * 2s);
        }
        
        /* 鍵盤指示器樣式 */
        .keyboard-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }
        
        .key {
            width: 30px;
            height: 30px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 5px;
            color: rgba(212, 175, 55, 0.8);
            font-size: 14px;
            background: rgba(93, 64, 55, 0.15);
        }
        
        /* 頁面轉場 */
        .page-transition {
            transition: opacity 0.8s ease, transform 0.8s ease;
        }
        
        .page-hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
        }
        
        /* 指揮棒動畫 */
        .conductor-wand {
            transform-origin: bottom center;
            position: relative;
        }
        
        .conducting {
            animation: conducting 0.5s ease-in-out;
        }
        
        @keyframes conducting {
            0% { transform: rotate(-20deg); }
            50% { transform: rotate(30deg); }
            100% { transform: rotate(-10deg); }
        }
        
        /* 指揮棒反光效果 */
        .wand-highlight {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 70%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.7), transparent);
            opacity: 0.4;
        }
        
        /* 反應性指示器 */
        .reactive-indicator {
            transition: all 0.3s ease;
        }
        
        .reactive-indicator.active {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }
        
        /* 精準度指示器增強 */
        .accuracy-bar-container {
            position: relative;
            background: rgba(30, 30, 30, 0.5);
            border-radius: 999px;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
        }
        
        .accuracy-bar {
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.5), rgba(212, 175, 55, 0.8));
            transition: width 0.5s ease-out;
            position: relative;
        }
        
        .accuracy-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.2), transparent);
            border-radius: 999px 999px 0 0;
        }
        
        /* 音符裝飾 */
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }
        
        .music-note {
            position: absolute;
            opacity: 0.1;
            pointer-events: none;
        }
        
        .note-1 {
            top: 20%;
            left: 10%;
            animation: float 10s ease-in-out infinite;
        }
        
        .note-2 {
            top: 60%;
            right: 15%;
            animation: float 13s ease-in-out infinite 1s;
        }
        
        .note-3 {
            bottom: 15%;
            left: 20%;
            animation: float 15s ease-in-out infinite 2s;
        }
        
        /* 模擬舞台照明 */
        .stage-lighting {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            overflow: hidden;
            opacity: 0;
            transition: opacity 1s ease;
        }
        
        .stage-lighting.active {
            opacity: 1;
        }
        
        .lighting-beam {
            position: absolute;
            width: 150px;
            height: 150%;
            background: radial-gradient(ellipse at top, rgba(212, 175, 55, 0.1), transparent 70%);
            transform-origin: top center;
        }
        
        .beam-1 {
            left: 20%;
            transform: rotate(-20deg);
            animation: beam-move-1 10s infinite alternate;
        }
        
        .beam-2 {
            left: 50%;
            transform: rotate(0deg);
            animation: beam-move-2 15s infinite alternate-reverse;
        }
        
        .beam-3 {
            right: 20%;
            transform: rotate(20deg);
            animation: beam-move-3 12s infinite alternate;
        }
        
        @keyframes beam-move-1 {
            0% { transform: rotate(-25deg); }
            100% { transform: rotate(-15deg); }
        }
        
        @keyframes beam-move-2 {
            0% { transform: rotate(-5deg); }
            100% { transform: rotate(5deg); }
        }
        
        @keyframes beam-move-3 {
            0% { transform: rotate(15deg); }
            100% { transform: rotate(25deg); }
        }
        
        /* 模擬木質指揮台 */
        .podium {
            background: linear-gradient(135deg, #5d4037 0%, #3e2723 100%);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            border-radius: 8px;
        }
        
        .podium::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml,%3Csvg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M0 0h20v20H0V0zm10 17L0 27v10h10V17zm10 0L10 27v10h10V17zM0 0v7l10 10h20V0H0z" fill="%23000000" fill-opacity="0.1" fill-rule="evenodd"/%3E%3C/svg%3E');
            opacity: 0.1;
        }
        
        /* 模擬絲絨窗簾 */
        .velvet-curtain {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: #5D0A0A; /* 深紅絲絨色 */
            box-shadow: 0 0 10px rgba(93, 10, 10, 0.5);
            z-index: 1;
        }
        
        /* BPM 脈動效果 */
        .bpm-pulse {
            animation: bpm-pulse 0.5s ease-in-out;
        }
        
        @keyframes bpm-pulse {
            0% { transform: scale(1); color: rgba(212, 175, 55, 0.9); }
            50% { transform: scale(1.1); color: rgba(212, 175, 55, 1); text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
            100% { transform: scale(1); color: rgba(212, 175, 55, 0.9); }
        }
        
        /* 指揮家圖標動畫 */
        .conductor-icon {
            position: relative;
            transition: all 0.5s ease;
        }
        
        .conductor-icon:hover .conductor-wand {
            animation: conducting 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <!-- 舞台背景效果 -->
    <div class="concert-hall"></div>
    <div class="spotlights">
        <div class="spotlight spotlight-1"></div>
        <div class="spotlight spotlight-2"></div>
        <div class="spotlight spotlight-3"></div>
    </div>
    <div class="stage-texture"></div>
    
    <!-- 音符裝飾 -->
    <div class="music-note note-1">♪</div>
    <div class="music-note note-2">♫</div>
    <div class="music-note note-3">♩</div>
    
    <!-- 封面頁 -->
    <div id="cover-page" class="cover-page page-transition">
        <div id="music-notes-container" class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
            <!-- 音符將由JS動態生成 -->
        </div>
        
        <h1 class="cover-title text-5xl md:text-6xl font-bold mb-4 text-center text-conductor-gold">交響樂指揮家</h1>
        <p class="cover-subtitle text-xl mb-8 text-center text-gray-300">展現您的音樂天賦，帶領樂團演繹經典樂章</p>
        
        <div class="orchestra-image mb-10 mt-4">
            <div class="conductor-icon mx-auto relative">
                <img src="./images/ConductorFront.png" alt="指揮家" class="w-auto h-48 object-contain mx-auto filter drop-shadow-2xl" />
            </div>
        </div>
        
        <button id="start-game-button" class="grand-button mb-8 animate-pulse-slow">
            開始指揮
        </button>
        
        <div class="text-center text-gray-400 text-sm max-w-md px-4">
            使用您的 Micro:bit 作為指揮棒，或使用鍵盤空格鍵指揮樂團，體驗音樂指揮的魅力
        </div>
    </div>

    <!-- 主遊戲內容 -->
    <div id="main-content" class="container mx-auto px-4 py-8 max-w-3xl page-transition page-hidden">
        <h1 class="text-3xl font-bold mb-6 text-center text-conductor-gold">交響樂指揮家</h1>

        <!-- 遊戲狀態視窗 -->
        <div id="game-container" class="relative mb-8 p-6 rounded-lg shadow-lg conductor-stage">
            <!-- 絲絨窗簾裝飾 -->
            <div class="velvet-curtain"></div>
            
            <!-- 舞台燈光效果 -->
            <div class="stage-lighting" id="stage-lighting">
                <div class="lighting-beam beam-1"></div>
                <div class="lighting-beam beam-2"></div>
                <div class="lighting-beam beam-3"></div>
            </div>
            
            <!-- 旋律波浪效果 -->
            <div class="melody-wave" id="melody-wave"></div>
            
            <!-- 標題與連接按鈕區域 -->
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 class="text-xl font-semibold mb-2 text-conductor-gold">歡迎進入交響樂殿堂</h2>
                    <p class="text-sm text-gray-400">指揮您的音樂之旅</p>
                </div>
                <div id="connection-panel" class="text-right">
                    <button id="connect-button" class="elegant-button">
                        連接指揮棒
                    </button>
                    <div id="connection-status" class="mt-2 text-sm font-medium">未連接</div>
                </div>
            </div>
            
            <div class="gold-divider"></div>

            <!-- 遊戲準備區塊 -->
            <div id="setup-panel" class="hidden mb-6 pb-6">
                <h2 class="text-xl font-semibold mb-4 text-conductor-gold">選擇樂章</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <select id="music-select" class="w-full py-2 px-3 border border-conductor-gold bg-conductor-dark text-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-conductor-gold/50">
                        <option value="game_start">序曲：舞台準備</option>
                        <option value="waltz">華爾滋：藍色多瑙河（目標 BPM: 60）</option>
                        <option value="march">進行曲：拉德斯基（目標 BPM: 108）</option>
                        <option value="symphony">交響曲：命運之門（目標 BPM: 88）</option>
                    </select>
                    <div class="mt-2 text-xs text-gray-400">
                        計算方式：平均節拍法 | 靈敏度調整：420ms
                    </div>
                    <button id="start-music-button" class="elegant-button">
                        開始指揮
                    </button>
                </div>
                <div class="text-sm text-gray-400">
                    藝術指南：感受樂曲節奏，揮動您的指揮棒，展現您的音樂領導力
                </div>
            </div>

            <!-- 遊戲進行區塊 -->
            <div id="game-panel" class="hidden">
                <!-- 指揮動畫 -->
                <div class="flex justify-center items-center mb-8">
                    <div id="conductor-animation" class="relative h-56 w-56 flex justify-center items-center podium p-4 rounded-full">
                        <!-- 指揮家圖示 -->
                        <div class="absolute bottom-0 w-full flex justify-center">
                            <div class="relative w-24 h-24 rounded-full bg-conductor-dark flex items-center justify-center border border-conductor-gold/20 shadow-xl">
                                <div class="w-20 h-20 rounded-full bg-conductor-medium flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-conductor-gold" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                </div>
                                <!-- 指揮棒 -->
                                <div id="conductor-wand" class="conductor-wand absolute h-28 w-1.5 bg-conductor-gold/90 rounded-full" style="bottom: 50%; transform: rotate(-10deg);">
                                    <div class="absolute top-0 left-0 right-0 h-4 rounded-full bg-white/80"></div>
                                    <div class="wand-highlight"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 遊戲狀態信息 -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="p-4 rounded-lg bg-conductor-medium border border-conductor-gold/10 shadow text-center reactive-indicator">
                        <div class="text-sm text-gray-400 mb-1">您的節奏</div>
                        <div id="current-bpm" class="text-3xl font-bold text-conductor-gold">--</div>
                    </div>
                    <div class="p-4 rounded-lg bg-conductor-medium border border-conductor-gold/10 shadow text-center reactive-indicator">
                        <div class="text-sm text-gray-400 mb-1">樂曲節奏</div>
                        <div id="target-bpm" class="text-3xl font-bold text-green-400">--</div>
                    </div>
                </div>
                
                <!-- 音樂速度提示 -->
                <div id="speed-notification" class="hidden mb-6 py-2 px-4 rounded-lg text-center text-white transition-all duration-300 transform scale-100">
                    <span id="speed-text">音樂速度已調整</span>
                </div>

                <!-- BPM 差異指示器 -->
                <div class="mb-6">
                    <div class="text-sm text-gray-400 mb-2">節奏偏差：<span id="bpm-diff" class="text-conductor-gold">--</span></div>
                    <div class="relative h-8 bg-conductor-dark/70 rounded-full overflow-hidden border border-conductor-gold/10">
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="w-px h-full bg-conductor-gold/30"></div>
                        </div>
                        <div id="bpm-indicator" class="bpm-indicator absolute top-0 bottom-0 w-6 h-6 bg-conductor-gold rounded-full transform -translate-x-1/2 shadow-lg shadow-conductor-gold/20" style="left: 50%;">
                            <div class="absolute inset-0 rounded-full bg-conductor-gold/20 animate-pulse"></div>
                        </div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>過慢</span>
                        <span>完美</span>
                        <span>過快</span>
                    </div>
                </div>

                <!-- 練習模式提示 -->
                <div id="practice-mode-banner" class="hidden mb-6 py-3 px-4 rounded-lg bg-conductor-dark border border-conductor-gold/20 text-center">
                    <div class="text-lg font-semibold mb-1 text-conductor-gold"><span id="practice-countdown">10</span> 秒預備時間</div>
                    <div class="text-sm text-gray-400">請感受音樂節奏，掌握樂曲情感，此階段為熱身</div>
                </div>

                <!-- 精準度 -->
                <div class="mb-6">
                    <div class="flex justify-between text-sm font-medium mb-2">
                        <span>指揮精準度</span>
                        <span id="accuracy-percent" class="text-conductor-gold">0%</span>
                    </div>
                    <div class="accuracy-bar-container h-3 rounded-full">
                        <div id="accuracy-bar" class="accuracy-bar h-full w-0"></div>
                    </div>
                    <div id="accuracy-text" class="accuracy-text text-center py-2 font-medium text-lg transition-colors"></div>
                </div>

                <!-- 進度條 -->
                <div class="mb-6">
                    <div class="flex justify-between text-sm mb-1">
                        <div>樂章進度</div>
                        <div id="time-display" class="text-conductor-gold/80">00:00 / 00:00</div>
                    </div>
                    <div class="w-full bg-conductor-dark/70 rounded-full h-2 overflow-hidden border border-conductor-gold/10">
                        <div id="progress-bar" class="bg-gradient-to-r from-conductor-gold/60 to-conductor-gold/80 h-2 rounded-full w-0 relative">
                            <div class="absolute inset-0 opacity-75 bg-conductor-gold/20 animate-pulse"></div>
                        </div>
                    </div>
                </div>

                <!-- 鍵盤指示器 -->
                <div class="keyboard-indicator mb-4">
                    <div class="key">空格</div>
                    <span class="text-gray-400 flex items-center mx-2">或</span>
                    <div class="key">↑</div>
                    <span class="text-gray-400 flex items-center mx-2">指揮棒</span>
                </div>

                <!-- 控制按鈕 -->
                <div class="flex justify-center mt-6">
                    <button id="stop-game-button" class="elegant-button bg-conductor-velvet/20 border-conductor-velvet/30 text-rose-300/90">
                        結束演出
                    </button>
                </div>
            </div>

            <!-- 遊戲結果區塊 -->
            <div id="result-panel" class="hidden">
                <h2 class="text-xl font-semibold mb-4 text-center text-conductor-gold">指揮表現評估</h2>
                <div class="p-6 rounded-lg bg-conductor-medium/70 border border-conductor-gold/20 shadow-lg mb-6">
                    <div id="result-title" class="text-2xl font-bold mb-4 text-center text-conductor-gold">精湛指揮！</div>
                    <div id="result-score" class="text-5xl font-bold text-conductor-gold mb-6 text-center">96%</div>
                    <div class="gold-divider"></div>
                    <div id="result-details" class="grid grid-cols-2 gap-x-8 gap-y-4 mb-6 max-w-sm mx-auto">
                        <div class="text-left">
                            <div class="text-sm text-gray-400">樂曲節奏</div>
                            <div id="result-target-bpm" class="text-lg font-medium text-conductor-gold/90">60</div>
                        </div>
                        <div class="text-left">
                            <div class="text-sm text-gray-400">平均節奏</div>
                            <div id="result-average-bpm" class="text-lg font-medium text-conductor-gold/90">62</div>
                        </div>
                        <div class="text-left">
                            <div class="text-sm text-gray-400">精確指揮</div>
                            <div id="result-accurate-beats" class="text-lg font-medium text-conductor-gold/90">45</div>
                        </div>
                        <div class="text-left">
                            <div class="text-sm text-gray-400">總指揮次數</div>
                            <div id="result-total-beats" class="text-lg font-medium text-conductor-gold/90">48</div>
                        </div>
                    </div>
                    <div class="gold-divider"></div>
                    <div id="result-comment" class="text-gray-300 mb-6 italic text-center">
                        您展現了卓越的藝術天賦，音樂在您的指揮下栩栩如生！
                    </div>
                    <div class="flex justify-center">
                        <button id="play-again-button" class="elegant-button">
                            再次指揮
                        </button>
                    </div>
                </div>
            </div>

            <!-- 音樂播放器（隱藏） -->
            <audio id="game-audio" class="hidden"></audio>
        </div>


    </div>

    <script>
        // 頁面切換控制與動態音符生成
        document.addEventListener("DOMContentLoaded", function() {
            const coverPage = document.getElementById('cover-page');
            const mainContent = document.getElementById('main-content');
            const startGameButton = document.getElementById('start-game-button');
            const musicNotesContainer = document.getElementById('music-notes-container');
            
            // 生成動態音符
            createDynamicMusicNotes();
            
            // 頁面切換事件
            startGameButton.addEventListener('click', function() {
                coverPage.classList.add('page-hidden');
                // 清除音符生成
                cleanupMusicNotes();
                setTimeout(() => {
                    mainContent.classList.remove('page-hidden');
                }, 400);
            });
            
            // 中央向外擴散的音符函數
            function createDynamicMusicNotes() {
                // 清空容器
                musicNotesContainer.innerHTML = '';
                
                // 音符符號庫
                const musicSymbols = ['♩', '♪', '♫', '♬', '𝄞', '𝅘𝅥𝅮', '𝅗𝅥', '𝄐', '𝄑'];
                
                // 創建固定數量的初始音符
                const initialNotes = 6;
                
                // 添加中央擴散的動畫樣式 (無旋轉)
                const centerRadiateStyle = document.createElement('style');
                centerRadiateStyle.textContent = `
                    @keyframes centerRadiate {
                        0% {
                            transform: translate(-50%, -50%) scale(0.5);
                            opacity: 0.6;
                        }
                        100% {
                            transform: translate(-50%, -50%) scale(3);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(centerRadiateStyle);
                
                // 定時生成新的音符
                function createNote() {
                    // 選擇隨機音符符號
                    const symbolIndex = Math.floor(Math.random() * musicSymbols.length);
                    const symbolText = musicSymbols[symbolIndex];
                    
                    // 創建音符元素
                    const note = document.createElement('div');
                    note.className = 'absolute pointer-events-none origin-center';
                    note.textContent = symbolText;
                    
                    // 設置初始位置為中央
                    note.style.left = '50%';
                    note.style.top = '50%';
                    
                    // 移除旋轉角度設置 (僅保留變數以供其他計算使用)
                    const rotationAngle = Math.floor(Math.random() * 360);
                    
                    // 設置隨機基礎大小 (12-24px)
                    const baseSize = Math.floor(Math.random() * 13) + 12;
                    note.style.fontSize = `${baseSize}px`;
                    
                    // 金色效果
                    note.style.color = 'rgba(212, 175, 55, 0.6)';
                    note.style.textShadow = '0 0 8px rgba(212, 175, 55, 0.3)';
                    
                    // 計算擴散方向 (0-360度)
                    const angle = Math.random() * 360;
                    
                    // 計算擴散距離 (螢幕寬度的50-150%)
                    const distance = 50 + Math.random() * 100;
                    
                    // 計算最終位置偏移量
                    const finalX = Math.cos(angle * Math.PI / 180) * distance;
                    const finalY = Math.sin(angle * Math.PI / 180) * distance;
                    
                    // 添加擴散動畫 (無旋轉)
                    const animationName = `centerRadiate_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    const keyframes = `
                    @keyframes ${animationName} {
                        0% {
                            transform: translate(-50%, -50%) scale(0.7);
                            opacity: 0.8;
                        }
                        100% {
                            transform: translate(calc(-50% + ${finalX}vw), calc(-50% + ${finalY}vh)) scale(2.5);
                            opacity: 0;
                        }
                    }`;
                    
                    const style = document.createElement('style');
                    style.textContent = keyframes;
                    document.head.appendChild(style);
                    
                    // 設置動畫持續時間 (8-15秒)
                    const duration = 8 + Math.random() * 7;
                    note.style.animation = `${animationName} ${duration}s cubic-bezier(0.1, 0.2, 0.3, 1) forwards`;
                    
                    // 添加至容器
                    musicNotesContainer.appendChild(note);
                    
                    // 設置動畫結束後移除元素
                    setTimeout(() => {
                        note.remove();
                        style.remove();
                    }, duration * 1000 + 100);
                }
                
                // 初始創建幾個音符
                for (let i = 0; i < initialNotes; i++) {
                    setTimeout(() => createNote(), i * 300);
                }
                
                // 設置定時器，每隔一段時間生成新的音符
                const noteInterval = setInterval(() => {
                    if (!document.contains(musicNotesContainer)) {
                        clearInterval(noteInterval);
                        return;
                    }
                    createNote();
                }, 2000); // 每2秒生成一個新音符
                
                // 存儲間隔定時器ID，以便在頁面切換時清除
                musicNotesContainer.dataset.intervalId = noteInterval;
            }
            
            // 頁面切換時清除音符生成定時器
            function cleanupMusicNotes() {
                const musicNotesContainer = document.getElementById('music-notes-container');
                if (musicNotesContainer && musicNotesContainer.dataset.intervalId) {
                    clearInterval(parseInt(musicNotesContainer.dataset.intervalId));
                }
            }
        });
        
        // 全局變數
        let port;
        let reader;
        let reading = false;
        let textDecoder = new TextDecoder();
        let accelerationCount = 0;
        
        // BPM 計算相關變數
        let timestamps = [];
        let lastTimestamp = 0;
        let bpm = 0;
        let lastInterval = 0;
        
        // 信號節流變數
        let lastSignalTime = 0;
        const throttleTime = 420; // 固定為 420 毫秒
        let isProcessing = false;
        
        // 遊戲相關變數
        let gameActive = false;
        let gameStartTime = 0;
        let currentMusic = null;
        let targetBpm = 0;
        let gameTimer = null;
        let isPracticeMode = true; // 初始為練習模式
        let practiceEndTime = 0; // 練習模式結束時間
        const PRACTICE_DURATION = 10; // 練習模式持續10秒
        let currentPlaybackRate = 1.0; // 當前音樂播放速度
        const FAST_PLAYBACK_RATE = 1.15; // 快速播放速度
        const SLOW_PLAYBACK_RATE = 0.85; // 慢速播放速度
        const BPM_THRESHOLD = 0.15; // BPM變化閾值 (15%)
        let gameData = {
            totalBeats: 0,
            accurateBeats: 0, // BPM差異 < 5 的準確節拍
            bpmReadings: []
        };
        let accuracyTimeoutId = null;
        let speedNotificationTimeoutId = null;
        
        // 舞台燈光和視覺效果
        let stageLighting = document.getElementById('stage-lighting');
        let melodyWave = document.getElementById('melody-wave');
        let isLightingActive = false;

        // 音樂資源設定
        const MUSIC_RESOURCES = {
            game_start: {
                url: 'https://cdn.jsdelivr.net/gh/iGitScor/Music-samples/wav/bubbles.wav',
                duration: 10,
                bpm: 0, // 非遊戲音樂
                title: '序曲：舞台準備'
            },
            waltz: {
                url: './audio/TheBlueDanube.mp3',
                duration: 30,
                bpm: 60,
                title: '華爾滋：藍色多瑙河',
                comment: '優雅的三拍子節奏，如同在宮廷舞會旋轉的舞者'
            },
            march: {
                url: './audio/RadetzkyMarch.mp3',
                duration: 30,
                bpm: 108,
                title: '進行曲：拉德斯基',
                comment: '精神抖擻的二拍子節奏，引領樂團展現活力與力量'
            },
            symphony: {
                url: './audio/FateSymphony.mp3',
                duration: 30,
                bpm: 88,
                title: '交響曲：命運之門',
                comment: '雄偉的四拍子節奏，指揮家與樂團的完美協奏'
            }
        };

        // DOM 元素
        const connectButton = document.getElementById('connect-button');
        const connectionStatus = document.getElementById('connection-status');
        const connectionPanel = document.getElementById('connection-panel');
        const setupPanel = document.getElementById('setup-panel');
        const gamePanel = document.getElementById('game-panel');
        const resultPanel = document.getElementById('result-panel');
        const musicSelect = document.getElementById('music-select');
        const startMusicButton = document.getElementById('start-music-button');
        const stopGameButton = document.getElementById('stop-game-button');
        const playAgainButton = document.getElementById('play-again-button');
        const gameAudio = document.getElementById('game-audio');
        const currentBpmDisplay = document.getElementById('current-bpm');
        const targetBpmDisplay = document.getElementById('target-bpm');
        const bpmDiffDisplay = document.getElementById('bpm-diff');
        const bpmIndicator = document.getElementById('bpm-indicator');
        const accuracyBar = document.getElementById('accuracy-bar');
        const accuracyPercent = document.getElementById('accuracy-percent');
        const accuracyText = document.getElementById('accuracy-text');
        const progressBar = document.getElementById('progress-bar');
        const timeDisplay = document.getElementById('time-display');
        const conductorWand = document.getElementById('conductor-wand');

        // 添加鍵盤控制支持
        document.addEventListener('keydown', function(event) {
            if (gameActive && (event.code === 'Space' || event.code === 'ArrowUp')) {
                event.preventDefault();
                simulateBeat();
            }
        });
        
        // 模擬指揮棒敲擊
        function simulateBeat() {
            // 節流處理
            const now = performance.now();
            if (now - lastSignalTime < throttleTime) {
                return;
            }
            
            isProcessing = true;
            lastSignalTime = now;
            
            // 處理敲擊
            conductorBeat();
            
            setTimeout(() => {
                isProcessing = false;
            }, 50);
        }

        // 檢查 Web Serial API 支援
        if (!('serial' in navigator)) {
            connectionStatus.textContent = '您的瀏覽器不支援 Micro:bit 連接。請使用鍵盤操作。';
            connectionStatus.classList.add('text-yellow-500');
            connectButton.textContent = '使用鍵盤模式';
            connectButton.addEventListener('click', function() {
                setupPanel.classList.remove('hidden');
            });
        } else {
            // 連接按鈕點擊事件
            connectButton.addEventListener('click', async () => {
                try {
                    // 請求 serial port
                    port = await navigator.serial.requestPort();
                    await port.open({ baudRate: 115200 });
                    
                    connectionStatus.textContent = '已連接指揮棒';
                    connectionStatus.classList.add('text-green-400');
                    connectButton.textContent = '連接成功';
                    connectButton.classList.add('bg-conductor-velvet/20');
                    connectButton.disabled = true;
                    
                    // 成功連接後，直接顯示遊戲設置面板
                    setupPanel.classList.remove('hidden');
                    
                    // 開始讀取數據
                    readSerialData();
                    
                } catch (error) {
                    console.error('連接錯誤:', error);
                    connectionStatus.textContent = '連接失敗，請使用鍵盤操作。';
                    connectionStatus.classList.add('text-yellow-500');
                    setupPanel.classList.remove('hidden');
                }
            });
        }

        // 啟動燈光效果
        function activateLighting() {
            if (!isLightingActive) {
                stageLighting.classList.add('active');
                isLightingActive = true;
            }
        }
        
        // 觸發旋律波浪動畫
        function triggerMelodyWave() {
            melodyWave.classList.remove('active');
            void melodyWave.offsetWidth; // 觸發重排
            melodyWave.classList.add('active');
        }

        // 開始遊戲按鈕
        startMusicButton.addEventListener('click', startGame);
        
        // 停止遊戲按鈕
        stopGameButton.addEventListener('click', endGame);
        
        // 再玩一次按鈕
        playAgainButton.addEventListener('click', resetGame);

        // 讀取串口數據
        async function readSerialData() {
            if (reading) return;
            
            reading = true;
            reader = port.readable.getReader();
            
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    
                    if (done) {
                        break;
                    }
                    
                    // 處理接收到的數據
                    processData(value);
                }
            } catch (error) {
                console.error('讀取錯誤:', error);
            } finally {
                reader.releaseLock();
                reading = false;
                
                // 如果連接還存在，則嘗試再次讀取
                if (port && port.readable) {
                    setTimeout(readSerialData, 100);
                } else {
                    connectionStatus.textContent = '連接已斷開，可使用鍵盤操作';
                    connectionStatus.classList.remove('text-green-400');
                    connectionStatus.classList.add('text-yellow-500');
                    
                    // 如果遊戲正在進行，則繼續
                    if (gameActive) {
                        // 不結束遊戲，讓用戶可以使用鍵盤繼續
                    }
                }
            }
        }

        // 處理接收到的數據
        function processData(data) {
            const text = textDecoder.decode(data).trim();
            
            // 檢查是否接收到 "b" 信號
            if (text.includes('b')) {
                // 節流處理 - 忽略節流時間內的連續信號
                const now = performance.now();
                if (now - lastSignalTime < throttleTime) {
                    return;
                }
                
                // 如果正在處理中，也忽略
                if (isProcessing) {
                    return;
                }
                
                isProcessing = true;
                lastSignalTime = now;
                
                // 處理加速度檢測
                if (gameActive) {
                    conductorBeat();
                }
                
                // 設定短時間後重置處理標誌，以確保信號處理完畢
                setTimeout(() => {
                    isProcessing = false;
                }, 50);
            }
        }

        // 開始遊戲
        function startGame() {
            const musicKey = musicSelect.value;
            currentMusic = MUSIC_RESOURCES[musicKey];
            targetBpm = currentMusic.bpm;
            
            // 啟動燈光效果
            activateLighting();
            
            // 不是遊戲音樂則返回選擇界面
            if (targetBpm === 0) {
                gameAudio.src = currentMusic.url;
                gameAudio.play();
                return;
            }
            
            // 重置遊戲數據
            gameData = {
                totalBeats: 0,
                accurateBeats: 0,
                bpmReadings: []
            };
            
            // 重置練習模式
            isPracticeMode = true;
            
            // 設置音頻並播放
            gameAudio.src = currentMusic.url;
            gameAudio.onloadedmetadata = () => {
                // 更新界面
                connectionPanel.classList.add('hidden');
                setupPanel.classList.add('hidden');
                gamePanel.classList.remove('hidden');
                
                // 顯示練習模式橫幅
                const practiceBanner = document.getElementById('practice-mode-banner');
                const practiceCountdown = document.getElementById('practice-countdown');
                practiceBanner.classList.remove('hidden');
                practiceCountdown.textContent = PRACTICE_DURATION;
                
                // 設置目標 BPM 顯示
                targetBpmDisplay.textContent = targetBpm;
                currentBpmDisplay.textContent = '--';
                bpmDiffDisplay.textContent = '--';
                
                // 重置 BPM 指示器
                bpmIndicator.style.left = '50%';
                
                // 重置精準度
                accuracyBar.style.width = '0%';
                accuracyPercent.textContent = '0%';
                
                // 重置進度條
                updateProgressBar(0);
                
                // 開始遊戲
                gameActive = true;
                gameStartTime = performance.now();
                gameAudio.play();
                
                // 設置練習結束時間
                practiceEndTime = gameAudio.currentTime + PRACTICE_DURATION;
                
                // 設置遊戲計時器
                const duration = gameAudio.duration;
                updateTimeDisplay(0, duration);
                
                // 設置進度更新定時器
                gameTimer = setInterval(() => {
                    const currentTime = gameAudio.currentTime;
                    const duration = gameAudio.duration;
                    
                    updateProgressBar(currentTime / duration * 100);
                    updateTimeDisplay(currentTime, duration);
                    
                    // 更新練習模式倒計時
                    if (isPracticeMode) {
                        const practiceTimeLeft = Math.max(0, Math.ceil(practiceEndTime - currentTime));
                        practiceCountdown.textContent = practiceTimeLeft;
                        
                        // 練習時間結束
                        if (practiceTimeLeft === 0) {
                            isPracticeMode = false;
                            
                            // 隱藏練習模式提示，顯示轉場動畫和提示
                            practiceBanner.classList.add('hidden');
                            
                            // 重置計分數據，開始正式計分
                            gameData = {
                                totalBeats: 0,
                                accurateBeats: 0,
                                bpmReadings: []
                            };
                            
                            // 顯示開始計分提示
                            showAccuracyFeedback('開始正式計分！', 'text-conductor-gold');
                            
                            // 重置精準度顯示
                            accuracyBar.style.width = '0%';
                            accuracyPercent.textContent = '0%';
                        }
                    }
                    
                    // 檢查遊戲是否結束
                    if (currentTime >= duration) {
                        endGame();
                    }
                }, 100);
            };
        }

        // 計算 BPM - 平均法
        function calculateAverageBPM() {
            if (timestamps.length < 2) return 0;
            
            // 計算時間間隔（以毫秒為單位）
            const intervals = [];
            for (let i = 1; i < timestamps.length; i++) {
                intervals.push(timestamps[i] - timestamps[i - 1]);
            }
            
            // 計算平均間隔
            const averageInterval = intervals.reduce((sum, interval) => sum + interval, 0) / intervals.length;
            
            // 轉換為 BPM（每分鐘節拍數）
            return Math.round(60000 / averageInterval);
        }
        
        // 顯示音樂速度提示
        function showSpeedNotification(text, bgColor) {
            const speedNotification = document.getElementById('speed-notification');
            const speedText = document.getElementById('speed-text');
            
            // 清除之前的 timeout
            if (speedNotificationTimeoutId) {
                clearTimeout(speedNotificationTimeoutId);
            }
            
            // 更新文字和背景色
            speedText.textContent = text;
            speedNotification.style.backgroundColor = bgColor;
            
            // 顯示通知
            speedNotification.classList.remove('hidden');
            speedNotification.classList.add('scale-100');
            
            // 觸發旋律波浪效果
            triggerMelodyWave();
            
            // 設置淡出
            speedNotificationTimeoutId = setTimeout(() => {
                speedNotification.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    speedNotification.classList.add('hidden');
                    speedNotification.classList.remove('scale-95', 'opacity-0');
                }, 300);
            }, 2000);
        }
        
        // 調整音樂播放速度
        function adjustPlaybackRate(newBpm) {
            if (!gameAudio || isPracticeMode) return;
            
            let newRate = 1.0;
            
            // 根據 BPM 差異調整播放速度
            if (newBpm > targetBpm * (1 + BPM_THRESHOLD)) {
                newRate = FAST_PLAYBACK_RATE;
            } else if (newBpm < targetBpm * (1 - BPM_THRESHOLD)) {
                newRate = SLOW_PLAYBACK_RATE;
            }
            
            // 只有當速度改變時才更新
            if (newRate !== currentPlaybackRate) {
                // 更新播放速度
                gameAudio.playbackRate = newRate;
                currentPlaybackRate = newRate;
                
                // 顯示速度變化通知
                if (newRate === FAST_PLAYBACK_RATE) {
                    showSpeedNotification('樂團加速！您的節奏過快', '#FF9800');
                } else if (newRate === SLOW_PLAYBACK_RATE) {
                    showSpeedNotification('樂團減速！您的節奏過慢', '#2196F3');
                } else {
                    showSpeedNotification('樂團跟隨您的領導，節奏恢復', '#4CAF50');
                }
            }
        }
        
        // 指揮動作
        function conductorBeat() {
            accelerationCount++;
            const now = performance.now();
            
            // 添加指揮棒動畫
            conductorWand.classList.add('conducting');
            setTimeout(() => {
                conductorWand.classList.remove('conducting');
            }, 400);
            
            // 觸發旋律波浪
            triggerMelodyWave();
            
            // 記錄時間戳以計算平均 BPM
            timestamps.push(now);
            
            // 保持固定數量的樣本 (最近5個)
            if (timestamps.length > 5) {
                timestamps.shift();
            }
            
            let newBpm = 0;
            let interval = 0;
            
            if (lastTimestamp) {
                interval = now - lastTimestamp;
                lastInterval = interval;
                
                // 只有在合理範圍內的間隔才計算 BPM（300-2000ms 大致對應 30-200 BPM）
                if (interval >= 300 && interval <= 2000) {
                    // 使用平均值計算 BPM
                    newBpm = calculateAverageBPM();
                    
                    // 更新當前 BPM 顯示
                    currentBpmDisplay.textContent = newBpm;
                    currentBpmDisplay.classList.add('bpm-pulse');
                    setTimeout(() => {
                        currentBpmDisplay.classList.remove('bpm-pulse');
                    }, 500);
                    
                    // 計算與目標 BPM 的差異
                    const bpmDiff = newBpm - targetBpm;
                    
                    // 更新 BPM 差異顯示
                    if (bpmDiff > 0) {
                        bpmDiffDisplay.textContent = `+${bpmDiff} (過快)`;
                    } else if (bpmDiff < 0) {
                        bpmDiffDisplay.textContent = `${bpmDiff} (過慢)`;
                    } else {
                        bpmDiffDisplay.textContent = `完美!`;
                    }
                    
                    // 更新 BPM 指示器位置
                    const indicatorPos = Math.max(0, Math.min(100, 50 + (bpmDiff / targetBpm * 50)));
                    bpmIndicator.style.left = `${indicatorPos}%`;
                    
                    // BPM 指示器脈動效果
                    bpmIndicator.classList.add('animate-pulse');
                    setTimeout(() => {
                        bpmIndicator.classList.remove('animate-pulse');
                    }, 500);
                    
                    // 調整音樂播放速度
                    adjustPlaybackRate(newBpm);
                    
                    // 只有在非練習模式下才更新計分
                    if (!isPracticeMode) {
                        // 更新遊戲數據
                        gameData.totalBeats++;
                        gameData.bpmReadings.push(newBpm);
                        
                        // 添加指揮反饋效果
                        document.querySelectorAll('.reactive-indicator').forEach(el => {
                            el.classList.add('active');
                            setTimeout(() => {
                                el.classList.remove('active');
                            }, 300);
                        });
                        
                        // 更新精準度
                        if (Math.abs(bpmDiff) <= 5) {
                            gameData.accurateBeats++;
                            showAccuracyFeedback('精彩！完美節奏', 'text-green-400');
                        } else if (Math.abs(bpmDiff) <= 10) {
                            showAccuracyFeedback('樂團跟隨您的指揮', 'text-yellow-400');
                        } else {
                            showAccuracyFeedback('調整您的指揮節奏', 'text-red-400');
                        }
                        
                        // 計算並更新精準度百分比
                        const accuracy = (gameData.accurateBeats / gameData.totalBeats * 100).toFixed(0);
                        accuracyBar.style.width = `${accuracy}%`;
                        accuracyPercent.textContent = `${accuracy}%`;
                    } else {
                        // 練習模式下的反饋
                        if (Math.abs(bpmDiff) <= 5) {
                            showAccuracyFeedback('感受樂曲的脈動...', 'text-blue-400');
                        } else if (Math.abs(bpmDiff) <= 10) {
                            showAccuracyFeedback('尋找音樂的節奏...', 'text-blue-400');
                        } else {
                            showAccuracyFeedback('熟悉樂團的呼吸...', 'text-blue-400');
                        }
                    }
                }
            }
            
            // 更新最後一次時間戳
            lastTimestamp = now;
        }

        // 顯示精準度反饋
        function showAccuracyFeedback(text, colorClass) {
            // 清除之前的 timeout
            if (accuracyTimeoutId) {
                clearTimeout(accuracyTimeoutId);
            }
            
            // 移除之前的顏色類並添加新類
            accuracyText.className = 'accuracy-text transition-colors ' + colorClass;
            accuracyText.textContent = text;
            accuracyText.classList.add('show');
            
            // 設置淡出
            accuracyTimeoutId = setTimeout(() => {
                accuracyText.classList.remove('show');
            }, 1500);
        }

        // 更新進度條
        function updateProgressBar(percent) {
            progressBar.style.width = `${percent}%`;
        }

        // 更新時間顯示
        function updateTimeDisplay(currentTime, duration) {
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };
            
            timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
        }

        // 結束遊戲
        function endGame() {
            // 停止音樂和計時器
            gameAudio.pause();
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }
            
            // 標記遊戲結束
            gameActive = false;
            
            // 更新界面
            gamePanel.classList.add('hidden');
            resultPanel.classList.remove('hidden');
            
            // 計算遊戲結果
            const totalBeats = gameData.totalBeats;
            const accurateBeats = gameData.accurateBeats;
            const accuracy = totalBeats > 0 ? (accurateBeats / totalBeats * 100).toFixed(0) : 0;
            
            // 計算平均 BPM
            let averageBpm = 0;
            if (gameData.bpmReadings.length > 0) {
                averageBpm = Math.round(
                    gameData.bpmReadings.reduce((sum, bpm) => sum + bpm, 0) / gameData.bpmReadings.length
                );
            }
            
            // 設置結果標題和評級
            let resultTitle = '';
            let resultComment = '';
            
            if (accuracy >= 90) {
                resultTitle = '大師級指揮！';
                resultComment = '您的藝術風采如暴風般席捲全場，樂團在您的指揮下綻放最璀璨的光芒！';
            } else if (accuracy >= 70) {
                resultTitle = '精湛指揮家！';
                resultComment = '您對音樂的理解與感染力讓樂團與您心靈相通，演繹出動人的樂章！';
            } else if (accuracy >= 50) {
                resultTitle = '有潛力的指揮家';
                resultComment = '您具備自然的音樂天賦，隨著經驗的累積，終將成就非凡的指揮生涯！';
            } else {
                resultTitle = '初學指揮家';
                resultComment = '音樂是一段美麗的旅程，持續練習與感受，您將發現指揮的無窮樂趣！';
            }
            
            // 更新結果面板
            document.getElementById('result-title').textContent = resultTitle;
            document.getElementById('result-score').textContent = `${accuracy}%`;
            document.getElementById('result-target-bpm').textContent = targetBpm;
            document.getElementById('result-average-bpm').textContent = averageBpm || '--';
            document.getElementById('result-accurate-beats').textContent = accurateBeats;
            document.getElementById('result-total-beats').textContent = totalBeats;
            document.getElementById('result-comment').textContent = resultComment;
        }

        // 重置遊戲
        function resetGame() {
            resultPanel.classList.add('hidden');
            setupPanel.classList.remove('hidden');
            
            // 重置遊戲數據
            lastTimestamp = 0;
            accelerationCount = 0;
            gameData = {
                totalBeats: 0,
                accurateBeats: 0,
                bpmReadings: []
            };
        }
    </script>
</body>
</html>
