<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDC交響樂指揮家</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#d4af37', // 金色
                        secondary: '#8b4513', // 深棕色
                        accent: '#964B00', // 銅色
                        success: '#4CAF50',
                        warning: '#FF9800',
                        danger: '#F44336',
                        conductor: {
                            dark: '#121212',
                            medium: '#1a1a1a',
                            light: '#222222',
                            gold: '#d4af37',
                            copper: '#964B00',
                            velvet: '#5D0A0A',
                            wood: '#5d4037',
                        }
                    },
                    fontFamily: {
                        'sans': ['Noto Sans TC', 'sans-serif'],
                    },
                    animation: {
                        'spotlight': 'spotlight 5s ease-in-out infinite',
                        'glow': 'glow 2s ease-in-out infinite',
                        'fade-in': 'fadeIn 1s ease-out forwards',
                        'fade-out': 'fadeOut 1s ease-out forwards',
                        'conductor': 'conductor 1s ease-in-out infinite',
                        'float-slow': 'float 20s ease-in-out infinite',
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'pendulum': 'pendulum 1s ease-in-out infinite',
                    },
                    keyframes: {
                        spotlight: {
                            '0%': { opacity: 0.5, transform: 'translate(-30%, -30%) scale(0.8)' },
                            '50%': { opacity: 0.8, transform: 'translate(-25%, -25%) scale(1)' },
                            '100%': { opacity: 0.5, transform: 'translate(-30%, -30%) scale(0.8)' },
                        },
                        glow: {
                            '0%, 100%': { filter: 'brightness(1)' },
                            '50%': { filter: 'brightness(1.2)' },
                        },
                        fadeIn: {
                            '0%': { opacity: 0 },
                            '100%': { opacity: 1 },
                        },
                        fadeOut: {
                            '0%': { opacity: 1 },
                            '100%': { opacity: 0 },
                        },
                        conductor: {
                            '0%, 100%': { transform: 'rotate(-5deg)' },
                            '50%': { transform: 'rotate(15deg)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' },
                        },
                        pulse: {
                            '0%, 100%': { opacity: 1 },
                            '50%': { opacity: 0.7 },
                        },
                        pendulum: {
                            '0%': { transform: 'rotate(-30deg)' },
                            '50%': { transform: 'rotate(30deg)' },
                            '100%': { transform: 'rotate(-30deg)' },
                        }
                    },
                    backgroundImage: {
                        'stage-texture': "url('data:image/svg+xml,%3Csvg width=\"100\" height=\"100\" viewBox=\"0 0 100 100\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cpath d=\"M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z\" fill=\"%239C92AC\" fill-opacity=\"0.05\" fill-rule=\"evenodd\"/%3E%3C/svg%3E')",
                    }
                }
            }
        }
    </script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Noto Sans TC', sans-serif;
            position: relative;
            overflow-x: hidden;
        }
        
        /* 舞台和聚光燈效果 */
        .concert-hall {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 30%, rgba(212, 175, 55, 0.08) 0%, rgba(212, 175, 55, 0) 50%),
                linear-gradient(180deg, #121212 0%, #0a0a0a 100%);
            z-index: -2;
        }
        
        .spotlights {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .spotlight {
            position: absolute;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.15) 0%, rgba(212, 175, 55, 0) 70%);
            width: 100%;
            height: 100%;
            opacity: 0;
            transform-origin: center;
        }
        
        .spotlight-1 {
            top: 0;
            left: 0;
            animation: spotlight-1 15s ease-in-out infinite;
        }
        
        .spotlight-2 {
            top: 0;
            right: 0;
            animation: spotlight-2 18s ease-in-out infinite 2s;
        }
        
        .spotlight-3 {
            bottom: 0;
            left: 30%;
            animation: spotlight-3 20s ease-in-out infinite 5s;
        }
        
        @keyframes spotlight-1 {
            0%, 100% { opacity: 0.4; transform: scale(0.8); }
            50% { opacity: 0.6; transform: scale(1); }
        }
        
        @keyframes spotlight-2 {
            0%, 100% { opacity: 0.3; transform: scale(0.7) rotate(-15deg); }
            50% { opacity: 0.5; transform: scale(0.9) rotate(-5deg); }
        }
        
        @keyframes spotlight-3 {
            0%, 100% { opacity: 0.3; transform: scale(0.7) rotate(10deg); }
            50% { opacity: 0.5; transform: scale(0.9) rotate(5deg); }
        }
        
        /* 舞台紋理 */
        .stage-texture {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml,%3Csvg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z" fill="%239C92AC" fill-opacity="0.05" fill-rule="evenodd"/%3E%3C/svg%3E');
            opacity: 0.12;
            z-index: -1;
        }
        
        /* 指揮台效果 */
        .conductor-stage {
            background: linear-gradient(180deg, rgba(93, 64, 55, 0.4) 0%, rgba(93, 64, 55, 0.25) 100%);
            border: 1px solid rgba(212, 175, 55, 0.1);
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5),
                        inset 0 0 15px rgba(212, 175, 55, 0.1);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .conductor-stage::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.05) 0%, rgba(212, 175, 55, 0) 50%);
            pointer-events: none;
        }
        
        /* 旋律波浪 */
        .melody-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0) 0%, rgba(212, 175, 55, 0.2) 50%, rgba(212, 175, 55, 0) 100%);
            filter: blur(2px);
            opacity: 0;
            transform: translateY(10px);
            z-index: 1;
        }
        
        .melody-wave.active {
            animation: wave 1.2s ease-out;
        }
        
        @keyframes wave {
            0% { opacity: 0; transform: translateY(10px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; width: 100%; }
            100% { opacity: 0; width: 100%; transform: translateY(0); }
        }
        
        /* 金色裝飾線 */
        .gold-divider {
            height: 1px;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0) 0%, rgba(212, 175, 55, 0.5) 50%, rgba(212, 175, 55, 0) 100%);
            margin: 12px 0;
        }
        
        /* 優雅按鈕 */
        .elegant-button {
            background: linear-gradient(to bottom, rgba(212, 175, 55, 0.2), rgba(150, 75, 0, 0.2));
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: rgba(212, 175, 55, 0.9);
            letter-spacing: 0.05em;
            padding: 8px 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border-radius: 4px;
        }
        
        .elegant-button:hover {
            background: linear-gradient(to bottom, rgba(212, 175, 55, 0.3), rgba(150, 75, 0, 0.3));
            border-color: rgba(212, 175, 55, 0.5);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }
        
        .elegant-button:active {
            transform: translateY(1px);
        }
        
        .elegant-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        
        .elegant-button:hover::after {
            left: 100%;
        }
        
        /* Cover Page 特效 */
        .cover-page {
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-image: url('./images/stage.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        /* 背景暗化覆蓋層 */
        .cover-page::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 0;
        }
        
        /* 確保內容顯示在覆蓋層上方 */
        .cover-page > * {
            position: relative;
            z-index: 1;
        }
        
        .cover-title {
            position: relative;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
            letter-spacing: 0.1em;
        }
        
        .cover-subtitle {
            position: relative;
            letter-spacing: 0.05em;
            opacity: 0.8;
        }
        
        .grand-button {
            background: linear-gradient(to bottom, rgba(212, 175, 55, 0.3), rgba(150, 75, 0, 0.3));
            border: 1px solid rgba(212, 175, 55, 0.5);
            color: rgba(255, 255, 255, 0.95);
            font-weight: 500;
            letter-spacing: 0.1em;
            padding: 12px 28px;
            font-size: 1.2rem;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            border-radius: 4px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .grand-button:hover {
            background: linear-gradient(to bottom, rgba(212, 175, 55, 0.4), rgba(150, 75, 0, 0.4));
            border-color: rgba(212, 175, 55, 0.7);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4), 0 0 15px rgba(212, 175, 55, 0.4);
            transform: translateY(-2px);
        }
        
        .grand-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .grand-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: 0.7s;
        }
        
        .grand-button:hover::after {
            left: 100%;
        }
        
        .orchestra-image {
            position: relative;
            width: 90%;
            max-width: 600px;
            margin: 0 auto;
            opacity: 0.7;
            filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.2));
        }
        
        .floating-note {
            position: absolute;
            color: rgba(212, 175, 55, 0.3);
            font-size: 2rem;
            filter: drop-shadow(0 0 8px rgba(212, 175, 55, 0.2));
            pointer-events: none;
            animation-duration: calc(15s + (var(--note-index) * 5s));
            animation-delay: calc(var(--note-index) * 2s);
        }
        
        /* 鍵盤指示器樣式 */
        .keyboard-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }
        
        .key {
            width: 30px;
            height: 30px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 5px;
            color: rgba(212, 175, 55, 0.8);
            font-size: 14px;
            background: rgba(93, 64, 55, 0.15);
        }
        
        /* 頁面轉場 */
        .page-transition {
            transition: opacity 0.8s ease, transform 0.8s ease;
            position: relative;
        }
        
        .page-hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
            position: absolute !important;
            top: 0;
            left: 0;
            right: 0;
            visibility: hidden;
            z-index: -1;
        }
        
        /* 指揮棒動畫 */
        .conductor-wand {
            transform-origin: bottom center;
            position: relative;
        }
        
        .conducting {
            animation: conducting 0.5s ease-in-out;
        }
        
        @keyframes conducting {
            0% { transform: rotate(-20deg); }
            50% { transform: rotate(30deg); }
            100% { transform: rotate(-10deg); }
        }
        
        /* 指揮棒反光效果 */
        .wand-highlight {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 70%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.7), transparent);
            opacity: 0.4;
        }
        
        /* 反應性指示器 */
        .reactive-indicator {
            transition: all 0.3s ease;
        }
        
        .reactive-indicator.active {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }
        
        /* 精準度指示器增強 */
        .accuracy-bar-container {
            position: relative;
            background: rgba(30, 30, 30, 0.5);
            border-radius: 999px;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
        }
        
        .accuracy-bar {
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.5), rgba(212, 175, 55, 0.8));
            transition: width 0.5s ease-out;
            position: relative;
        }
        
        .accuracy-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.2), transparent);
            border-radius: 999px 999px 0 0;
        }
        
        /* 音符裝飾 */
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }
        
        .music-note {
            position: absolute;
            opacity: 0.1;
            pointer-events: none;
        }
        
        .note-1 {
            top: 20%;
            left: 10%;
            animation: float 10s ease-in-out infinite;
        }
        
        .note-2 {
            top: 60%;
            right: 15%;
            animation: float 13s ease-in-out infinite 1s;
        }
        
        .note-3 {
            bottom: 15%;
            left: 20%;
            animation: float 15s ease-in-out infinite 2s;
        }
        
        /* 模擬舞台照明 */
        .stage-lighting {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            overflow: hidden;
            opacity: 0;
            transition: opacity 1s ease;
        }
        
        .stage-lighting.active {
            opacity: 1;
        }
        
        .lighting-beam {
            position: absolute;
            width: 150px;
            height: 150%;
            background: radial-gradient(ellipse at top, rgba(212, 175, 55, 0.1), transparent 70%);
            transform-origin: top center;
        }
        
        .beam-1 {
            left: 20%;
            transform: rotate(-20deg);
            animation: beam-move-1 10s infinite alternate;
        }
        
        .beam-2 {
            left: 50%;
            transform: rotate(0deg);
            animation: beam-move-2 15s infinite alternate-reverse;
        }
        
        .beam-3 {
            right: 20%;
            transform: rotate(20deg);
            animation: beam-move-3 12s infinite alternate;
        }
        
        @keyframes beam-move-1 {
            0% { transform: rotate(-25deg); }
            100% { transform: rotate(-15deg); }
        }
        
        @keyframes beam-move-2 {
            0% { transform: rotate(-5deg); }
            100% { transform: rotate(5deg); }
        }
        
        @keyframes beam-move-3 {
            0% { transform: rotate(15deg); }
            100% { transform: rotate(25deg); }
        }
        
        /* 模擬木質指揮台 */
        .podium {
            background: linear-gradient(135deg, #5d4037 0%, #3e2723 100%);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            border-radius: 8px;
        }
        
        .podium::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml,%3Csvg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M0 0h20v20H0V0zm10 17L0 27v10h10V17zm10 0L10 27v10h10V17zM0 0v7l10 10h20V0H0z" fill="%23000000" fill-opacity="0.1" fill-rule="evenodd"/%3E%3C/svg%3E');
            opacity: 0.1;
        }
        
        /* 模擬絲絨窗簾 */
        .velvet-curtain {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: #5D0A0A; /* 深紅絲絨色 */
            box-shadow: 0 0 10px rgba(93, 10, 10, 0.5);
            z-index: 1;
        }
        
        /* BPM 脈動效果 */
        .bpm-pulse {
            animation: bpm-pulse 0.5s ease-in-out;
        }
        
        @keyframes bpm-pulse {
            0% { transform: scale(1); color: rgba(212, 175, 55, 0.9); }
            50% { transform: scale(1.1); color: rgba(212, 175, 55, 1); text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
            100% { transform: scale(1); color: rgba(212, 175, 55, 0.9); }
        }
        
        /* 指揮家圖標動畫 */
        .conductor-icon {
            position: relative;
            transition: all 0.5s ease;
        }
        
        .conductor-icon:hover .conductor-wand {
            animation: conducting 1.5s ease-in-out infinite;
        }
        
        /* 節拍器樣式 */
        .metronome-container {
            position: relative;
            width: 100px;
            height: 160px;
            margin: 0 auto;
        }
        
        .metronome-base {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: linear-gradient(to bottom, #5d4037, #3e2723);
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1;
        }
        
        .metronome-body {
            position: absolute;
            bottom: 40px;
            left: 10px;
            width: 80px;
            height: 100px;
            background: linear-gradient(135deg, #964B00, #8B4513);
            border-radius: 6px 6px 0 0;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.4);
            z-index: 1;
        }
        
        .metronome-pendulum {
            position: absolute;
            width: 4px;
            height: 100px;
            background: #d4af37;
            bottom: 35px;
            left: 50%;
            transform: translateX(-50%) rotate(0deg);
            transform-origin: bottom center;
            z-index: 2;
        }
        
        .metronome-weight {
            position: absolute;
            width: 14px;
            height: 14px;
            background: #d4af37;
            border-radius: 50%;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }
        
        .metronome-tick {
            position: absolute;
            width: 100%;
            height: 2px;
            background: rgba(212, 175, 55, 0.3);
            z-index: 0;
        }
        
        .metronome-tick:nth-child(1) {
            transform: rotate(-30deg);
            top: 20px;
        }
        
        .metronome-tick:nth-child(2) {
            top: 50px;
        }
        
        .metronome-tick:nth-child(3) {
            transform: rotate(30deg);
            top: 20px;
        }
        
        .metronome-pendulum.active {
            animation: pendulum var(--duration) ease-in-out infinite;
        }
        
        @keyframes pendulum {
            0% { transform: translateX(-50%) rotate(-30deg); }
            50% { transform: translateX(-50%) rotate(30deg); }
            100% { transform: translateX(-50%) rotate(-30deg); }
        }
        
        /* BPM 範例區域 */
        .bpm-example {
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 8px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            margin: 8px 0;
            transition: all 0.3s ease;
        }
        
        .bpm-example:hover {
            border-color: rgba(212, 175, 55, 0.4);
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }
        
        .bpm-example-title {
            font-weight: 500;
            color: rgba(212, 175, 55, 0.9);
            margin-bottom: 4px;
        }
        
        /* 節拍器音頻視覺化 */
        .audio-wave {
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            margin: 10px 0;
        }
        
        .wave-bar {
            width: 3px;
            height: 5px;
            background: rgba(212, 175, 55, 0.3);
            border-radius: 1px;
            transition: height 0.1s ease;
        }
        
        .wave-bar.active {
            height: 24px;
            background: rgba(212, 175, 55, 0.9);
            box-shadow: 0 0 8px rgba(212, 175, 55, 0.5);
            animation: pulse-bar 0.3s ease-out;
        }
        
        @keyframes pulse-bar {
            0% { height: 5px; }
            50% { height: 24px; }
            100% { height: 16px; }
        }
        
        /* 練習模式區塊樣式 */
        .practice-panel {
            border-radius: 8px;
            background: rgba(26, 26, 26, 0.6);
            border: 1px solid rgba(212, 175, 55, 0.15);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        /* 精確度評估 */
        .accuracy-indicator {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            text-align: center;
            margin-top: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .accuracy-perfect {
            background-color: rgba(76, 175, 80, 0.2);
            color: #81c784;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .accuracy-good {
            background-color: rgba(255, 152, 0, 0.2);
            color: #ffb74d;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }
        
        .accuracy-adjust {
            background-color: rgba(244, 67, 54, 0.2);
            color: #e57373;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }
        
        /* 垂直分隔線 */
        .vertical-divider {
            width: 1px;
            background: linear-gradient(to bottom, rgba(212, 175, 55, 0), rgba(212, 175, 55, 0.3) 20%, rgba(212, 175, 55, 0.3) 80%, rgba(212, 175, 55, 0));
            margin: 0 auto;
        }
        
        /* 指揮動畫 */
        .mini-conductor {
            width: 100px;
            height: 150px;
            margin: 0 auto;
            position: relative;
        }
        
        .mini-conductor img {
            width: 100%;
            height: auto;
            object-fit: contain;
            transition: all 0.2s ease;
        }
        
        /* 提示閃爍 */
        .beat-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: rgba(212, 175, 55, 0.3);
            position: absolute;
            top: 10px;
            right: 10px;
            transition: all 0.2s ease;
        }
        
        .beat-indicator.active {
            background-color: rgba(212, 175, 55, 0.9);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }
        
        /* 遊戲模式選擇頁 */
        .mode-selection-page {
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .mode-card {
            width: 100%;
            max-width: 320px;
            height: 240px;
            background: rgba(26, 26, 26, 0.7);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
            transform-origin: center;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .mode-card:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: rgba(212, 175, 55, 0.5);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(212, 175, 55, 0.2);
        }
        
        .mode-card:active {
            transform: translateY(0) scale(0.98);
        }
        
        .mode-card-content {
            padding: 20px;
            position: relative;
            z-index: 2;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.7) 0%, rgba(0, 0, 0, 0) 100%);
        }
        
        .mode-card-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0.6;
            transition: opacity 0.3s ease, transform 0.5s ease;
            z-index: 1;
        }
        
        .mode-card:hover .mode-card-bg {
            opacity: 0.75;
            transform: scale(1.05);
        }
        
        .mode-coming-soon {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            transform: rotate(5deg);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            z-index: 3;
        }
        
        /* 彈出提示 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: rgba(26, 26, 26, 0.95);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- 舞台背景效果 -->
    <div class="concert-hall"></div>
    <div class="spotlights">
        <div class="spotlight spotlight-1"></div>
        <div class="spotlight spotlight-2"></div>
        <div class="spotlight spotlight-3"></div>
    </div>
    <div class="stage-texture"></div>
    
    <!-- 音符裝飾 -->
    <div class="music-note note-1">♪</div>
    <div class="music-note note-2">♫</div>
    <div class="music-note note-3">♩</div>
    
    <!-- 封面頁 -->
    <div id="cover-page" class="cover-page page-transition">
        <div id="music-notes-container" class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
            <!-- 音符將由JS動態生成 -->
        </div>
        
        <h1 class="cover-title text-5xl md:text-6xl font-bold mb-4 text-center text-conductor-gold">NDC交響樂指揮家</h1>
        <p class="cover-subtitle text-xl mb-8 text-center text-gray-300">展現您的音樂天賦，帶領樂團演繹經典樂章</p>
        
        <div class="orchestra-image mb-10 mt-4">
            <div class="conductor-icon mx-auto relative">
                <img src="./images/ConductorFront.png" alt="指揮家" class="w-auto h-48 object-contain mx-auto filter drop-shadow-2xl" />
            </div>
        </div>
        
        <button id="start-game-button" class="grand-button mb-8 animate-pulse-slow">
            開始指揮
        </button>
        
        <div class="text-center text-gray-400 text-sm max-w-md px-4">
            使用您的 Micro:bit 作為指揮棒，或使用鍵盤空格鍵指揮樂團，體驗音樂指揮的魅力
        </div>
    </div>
    
    <!-- 遊戲模式選擇頁面 -->
    <div id="mode-selection-page" class="mode-selection-page page-transition page-hidden">
        <h1 class="cover-title text-4xl md:text-5xl font-bold mb-6 text-center text-conductor-gold">選擇體驗模式</h1>
        <p class="cover-subtitle text-lg mb-10 text-center text-gray-300">探索不同的音樂指揮體驗</p>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto px-4">
            <!-- 教學模式卡片 -->
            <div id="tutorial-mode-card" class="mode-card">
                <div class="mode-card-bg" style="background-image: url('https://images.unsplash.com/photo-1507838153414-b4b713384a76?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80');"></div>
                <div class="mode-card-content">
                    <h3 class="text-xl font-bold text-conductor-gold mb-2">教學模式</h3>
                    <p class="text-sm text-gray-300">學習節拍感受與指揮基本技巧，為音樂演奏做準備</p>
                </div>
            </div>
            
            <!-- 演奏遊戲卡片 -->
            <div id="performance-mode-card" class="mode-card">
                <div class="mode-card-bg" style="background-image: url('https://images.unsplash.com/photo-1465847899084-d164df4dedc6?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80');"></div>
                <div class="mode-card-content">
                    <h3 class="text-xl font-bold text-conductor-gold mb-2">演奏遊戲</h3>
                    <p class="text-sm text-gray-300">選擇經典曲目，用您的指揮棒帶領樂團演奏美妙樂章</p>
                </div>
            </div>
            
            <!-- 故事模式卡片 -->
            <div id="story-mode-card" class="mode-card">
                <div class="mode-card-bg" style="background-image: url('https://images.unsplash.com/photo-1511735111819-9a3f7709049c?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80');"></div>
                <div class="mode-card-content">
                    <h3 class="text-xl font-bold text-conductor-gold mb-2">故事模式</h3>
                    <p class="text-sm text-gray-300">踏上音樂之旅，從新手指揮成長為大師級音樂家</p>
                </div>
                <div class="mode-coming-soon">敬請期待</div>
            </div>
        </div>
        
        <div class="mt-10">
            <button id="back-to-cover-button" class="elegant-button">
                返回首頁
            </button>
        </div>
        
        <!-- 連接狀態指示 -->
        <div id="connection-status-display" class="mt-6 text-center text-sm text-gray-400">
            使用鍵盤空格鍵或上箭頭進行指揮
        </div>
    </div>

    <!-- 主遊戲內容 -->
    <div id="main-content" class="container mx-auto px-4 py-8 max-w-4xl page-transition page-hidden">
        <h1 class="text-3xl font-bold mb-6 text-center text-conductor-gold">NDC交響樂指揮家</h1>

        <!-- 遊戲狀態視窗 -->
        <div id="game-container" class="relative mb-8 p-6 rounded-lg shadow-lg conductor-stage">
            <!-- 絲絨窗簾裝飾 -->
            <div class="velvet-curtain"></div>
            
            <!-- 舞台燈光效果 -->
            <div class="stage-lighting" id="stage-lighting">
                <div class="lighting-beam beam-1"></div>
                <div class="lighting-beam beam-2"></div>
                <div class="lighting-beam beam-3"></div>
            </div>
            
            <!-- 旋律波浪效果 -->
            <div class="melody-wave" id="melody-wave"></div>
            
            <!-- 標題與連接按鈕區域 -->
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 class="text-xl font-semibold mb-2 text-conductor-gold">歡迎進入交響樂殿堂</h2>
                    <p class="text-sm text-gray-400">指揮您的音樂之旅</p>
                </div>
                <div id="connection-panel" class="text-right hidden">
                    <div id="connection-status" class="text-sm font-medium">使用鍵盤空格鍵或上箭頭進行指揮</div>
                </div>
            </div>
            
            <div class="gold-divider"></div>

            <!-- 遊戲準備區塊 -->
            <div id="setup-panel" class="hidden mb-6 pb-6">
                <h2 class="text-xl font-semibold mb-4 text-conductor-gold">選擇樂章</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <select id="music-select" class="w-full py-2 px-3 border border-conductor-gold bg-conductor-dark text-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-conductor-gold/50">
                        <option value="newworld">德弗札克：新世界交響曲 第二樂章（目標 BPM: 55）</option>
                        <option value="ode">貝多芬：第九交響曲 歡樂頌（目標 BPM: 115）</option>
                        <option value="spring">韋瓦第：四季 春（目標 BPM: 85）</option>
                    </select>
                    <div class="mt-2 text-xs text-gray-400">
                        計算方式：平均節拍法 | 靈敏度調整：420ms
                    </div>
                    <button id="start-music-button" class="elegant-button">
                        開始指揮
                    </button>
                </div>
                <div class="text-sm text-gray-400">
                    藝術指南：感受樂曲節奏，揮動您的指揮棒，展現您的音樂領導力
                </div>
            </div>

            <!-- 遊戲進行區塊 -->
            <div id="game-panel" class="hidden">
                <!-- 指揮動畫 -->
                <div class="flex justify-center items-center mb-8">
                    <div id="conductor-animation" class="relative h-64 w-64 flex justify-center items-center podium p-4 overflow-hidden">
                        <!-- 指揮家圖片 -->
                        <div class="absolute inset-0 w-full h-full flex items-center justify-center">
                            <img id="conductor-image" src="./images/conductorback02.png" alt="指揮家背影" 
                                 class="object-contain max-h-full max-w-full transition-opacity duration-100" />
                        </div>
                    </div>
                </div>

                <!-- 遊戲狀態信息 -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="p-4 rounded-lg bg-conductor-medium border border-conductor-gold/10 shadow text-center reactive-indicator">
                        <div class="text-sm text-gray-400 mb-1">您的節奏</div>
                        <div id="current-bpm" class="text-3xl font-bold text-conductor-gold">--</div>
                    </div>
                    <div class="p-4 rounded-lg bg-conductor-medium border border-conductor-gold/10 shadow text-center reactive-indicator">
                        <div class="text-sm text-gray-400 mb-1">樂曲節奏</div>
                        <div id="target-bpm" class="text-3xl font-bold text-green-400">--</div>
                    </div>
                </div>
                
                <!-- 音樂速度提示 -->
                <div id="speed-notification" class="hidden mb-6 py-2 px-4 rounded-lg text-center text-white transition-all duration-300 transform scale-100">
                    <span id="speed-text">音樂速度已調整</span>
                </div>

                <!-- BPM 差異指示器 -->
                <div class="mb-6">
                    <div class="text-sm text-gray-400 mb-2">節奏偏差：<span id="bpm-diff" class="text-conductor-gold">--</span></div>
                    <div class="relative h-8 bg-conductor-dark/70 rounded-full overflow-hidden border border-conductor-gold/10">
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="w-px h-full bg-conductor-gold/30"></div>
                        </div>
                        <div id="bpm-indicator" class="bpm-indicator absolute top-0 bottom-0 w-6 h-6 bg-conductor-gold rounded-full transform -translate-x-1/2 shadow-lg shadow-conductor-gold/20" style="left: 50%;">
                            <div class="absolute inset-0 rounded-full bg-conductor-gold/20 animate-pulse"></div>
                        </div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>過慢</span>
                        <span>完美</span>
                        <span>過快</span>
                    </div>
                </div>

                <!-- 練習模式提示 -->
                <div id="practice-mode-banner" class="hidden mb-6 py-3 px-4 rounded-lg bg-conductor-dark border border-conductor-gold/20 text-center">
                    <div class="text-lg font-semibold mb-1 text-conductor-gold"><span id="practice-countdown">10</span> 秒預備時間</div>
                    <div class="text-sm text-gray-400">請感受音樂節奏，掌握樂曲情感，此階段為熱身</div>
                </div>

                <!-- 精準度 -->
                <div class="mb-6">
                    <div class="flex justify-between text-sm font-medium mb-2">
                        <span>指揮精準度</span>
                        <span id="accuracy-percent" class="text-conductor-gold">0%</span>
                    </div>
                    <div class="accuracy-bar-container h-3 rounded-full">
                        <div id="accuracy-bar" class="accuracy-bar h-full w-0"></div>
                    </div>
                    <div id="accuracy-text" class="accuracy-text text-center py-2 font-medium text-lg transition-colors"></div>
                </div>

                <!-- 進度條 -->
                <div class="mb-6">
                    <div class="flex justify-between text-sm mb-1">
                        <div>樂章進度</div>
                        <div id="time-display" class="text-conductor-gold/80">00:00 / 00:00</div>
                    </div>
                    <div class="w-full bg-conductor-dark/70 rounded-full h-2 overflow-hidden border border-conductor-gold/10">
                        <div id="progress-bar" class="bg-gradient-to-r from-conductor-gold/60 to-conductor-gold/80 h-2 rounded-full w-0 relative">
                            <div class="absolute inset-0 opacity-75 bg-conductor-gold/20 animate-pulse"></div>
                        </div>
                    </div>
                </div>

                <!-- 鍵盤指示器 -->
                <div class="keyboard-indicator mb-4">
                    <div class="key">空格</div>
                    <span class="text-gray-400 flex items-center mx-2">或</span>
                    <div class="key">↑</div>
                    <span class="text-gray-400 flex items-center mx-2">指揮棒</span>
                </div>

                <!-- 控制按鈕 -->
                <div class="flex justify-center mt-6">
                    <button id="stop-game-button" class="elegant-button bg-conductor-velvet/20 border-conductor-velvet/30 text-rose-300/90">
                        結束演出
                    </button>
                </div>
            </div>

            <!-- 遊戲結果區塊 -->
            <div id="result-panel" class="hidden">
                <h2 class="text-xl font-semibold mb-4 text-center text-conductor-gold">指揮表現評估</h2>
                <div class="p-6 rounded-lg bg-conductor-medium/70 border border-conductor-gold/20 shadow-lg mb-6">
                    <div id="result-title" class="text-2xl font-bold mb-4 text-center text-conductor-gold">精湛指揮！</div>
                    <div id="result-score" class="text-5xl font-bold text-conductor-gold mb-6 text-center">96%</div>
                    <div class="gold-divider"></div>
                    <div id="result-details" class="grid grid-cols-2 gap-x-8 gap-y-4 mb-6 max-w-sm mx-auto">
                        <div class="text-left">
                            <div class="text-sm text-gray-400">樂曲節奏</div>
                            <div id="result-target-bpm" class="text-lg font-medium text-conductor-gold/90">60</div>
                        </div>
                        <div class="text-left">
                            <div class="text-sm text-gray-400">平均節奏</div>
                            <div id="result-average-bpm" class="text-lg font-medium text-conductor-gold/90">62</div>
                        </div>
                        <div class="text-left">
                            <div class="text-sm text-gray-400">精確指揮</div>
                            <div id="result-accurate-beats" class="text-lg font-medium text-conductor-gold/90">45</div>
                        </div>
                        <div class="text-left">
                            <div class="text-sm text-gray-400">總指揮次數</div>
                            <div id="result-total-beats" class="text-lg font-medium text-conductor-gold/90">48</div>
                        </div>
                    </div>
                    <div class="gold-divider"></div>
                    <div id="result-comment" class="text-gray-300 mb-6 italic text-center">
                        您展現了卓越的藝術天賦，音樂在您的指揮下栩栩如生！
                    </div>
                    <div class="flex justify-center">
                        <button id="play-again-button" class="elegant-button">
                            再次指揮
                        </button>
                    </div>
                </div>
            </div>

            <!-- 教學模式面板 - 雙欄版面設計 -->
            <div id="tutorial-panel" class="hidden">
                <h2 class="text-xl font-semibold mb-4 text-center text-conductor-gold">節拍感受與指揮練習</h2>
                
                <!-- 分成左右兩欄 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 左側：節拍感受訓練 -->
                    <div class="practice-panel p-4">
                        <h3 class="text-lg font-medium mb-3 text-conductor-gold">節拍感受訓練</h3>
                        
                        <!-- 節拍器視覺化 -->
                        <div class="flex justify-center items-center mb-4">
                            <div class="metronome-container">
                                <div class="metronome-base"></div>
                                <div class="metronome-body">
                                    <div class="metronome-tick"></div>
                                    <div class="metronome-tick"></div>
                                    <div class="metronome-tick"></div>
                                </div>
                                <div id="metronome-pendulum" class="metronome-pendulum">
                                    <div class="metronome-weight"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 音頻視覺化 -->
                        <div class="audio-wave" id="audio-wave">
                            <!-- 聲音波形會被JS動態生成 -->
                        </div>
                        
                        <!-- BPM控制器 -->
                        <div class="mb-4">
                            <div class="flex justify-between mb-1">
                                <label for="bpm-slider" class="text-sm text-gray-300">BPM:</label>
                                <span id="bpm-value" class="text-conductor-gold font-bold">80</span>
                            </div>
                            <input type="range" id="bpm-slider" min="60" max="120" value="80" step="1" 
                                   class="w-full h-2 bg-conductor-dark rounded-lg appearance-none cursor-pointer accent-conductor-gold">
                            
                            <div class="flex justify-between text-xs text-gray-400 mt-1">
                                <span>慢 (60)</span>
                                <span>中 (90)</span>
                                <span>快 (120)</span>
                            </div>
                        </div>
                        
                        <!-- 節拍器控制按鈕 -->
                        <div class="flex justify-center mb-4">
                            <button id="start-metronome" class="elegant-button px-5 py-2">
                                <span id="metronome-toggle-text">開始</span>
                            </button>
                        </div>
                        
                        <!-- BPM 參考範例 -->
                        <div class="mt-4">
                            <h4 class="text-sm font-medium mb-2 text-conductor-gold">常見節奏範例</h4>
                            <div class="space-y-2">
                                <div class="bpm-example" data-bpm="60">
                                    <div class="bpm-example-title">60 BPM - 慢板</div>
                                </div>
                                
                                <div class="bpm-example" data-bpm="76">
                                    <div class="bpm-example-title">76 BPM - 行板</div>
                                </div>
                                
                                <div class="bpm-example" data-bpm="92">
                                    <div class="bpm-example-title">92 BPM - 中板</div>
                                </div>
                                
                                <div class="bpm-example" data-bpm="108">
                                    <div class="bpm-example-title">108 BPM - 小快板</div>
                                </div>
                                
                                <div class="bpm-example" data-bpm="120">
                                    <div class="bpm-example-title">120 BPM - 快板</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右側：指揮練習區 -->
                    <div class="practice-panel p-4">
                        <h3 class="text-lg font-medium mb-3 text-conductor-gold">指揮練習</h3>
                        
                        <!-- 指揮提示 -->
                        <div class="text-center mb-4 text-sm text-gray-300">
                            跟隨左側節拍器的節奏，用指揮棒或鍵盤空格鍵進行指揮
                        </div>
                        
                        <!-- 指揮家動畫 -->
                        <div class="flex justify-center mb-4 relative">
                            <div class="mini-conductor">
                                <img id="practice-conductor-image" src="./images/conductorback02.png" alt="指揮家背影" />
                                <div id="beat-indicator" class="beat-indicator"></div>
                            </div>
                        </div>
                        
                        <!-- 目前節奏指示器 -->
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="p-3 rounded-lg bg-conductor-dark border border-conductor-gold/10 text-center">
                                <div class="text-xs text-gray-400 mb-1">目標節奏</div>
                                <div id="practice-target-bpm" class="text-2xl font-bold text-green-400">80</div>
                            </div>
                            <div class="p-3 rounded-lg bg-conductor-dark border border-conductor-gold/10 text-center">
                                <div class="text-xs text-gray-400 mb-1">您的節奏</div>
                                <div id="practice-current-bpm" class="text-2xl font-bold text-conductor-gold">--</div>
                            </div>
                        </div>
                        
                        <!-- 精準度顯示 -->
                        <div>
                            <div class="text-sm text-gray-400 mb-2">節奏差異: <span id="practice-bpm-diff" class="text-conductor-gold">--</span></div>
                            <div class="relative h-6 bg-conductor-dark/70 rounded-full overflow-hidden border border-conductor-gold/10">
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <div class="w-px h-full bg-conductor-gold/30"></div>
                                </div>
                                <div id="practice-bpm-indicator" class="absolute top-0 bottom-0 w-4 h-4 bg-conductor-gold rounded-full transform -translate-x-1/2 shadow-lg shadow-conductor-gold/20" style="left: 50%;">
                                </div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>過慢</span>
                                <span>完美</span>
                                <span>過快</span>
                            </div>
                            
                            <!-- 精確度評估 -->
                            <div id="practice-accuracy" class="accuracy-indicator mt-3">
                                請開始指揮
                            </div>
                        </div>
                        
                        <!-- 鍵盤指示器 -->
                        <div class="keyboard-indicator mt-4 mb-2">
                            <div class="key">空格</div>
                            <span class="text-gray-400 flex items-center mx-2">或</span>
                            <div class="key">↑</div>
                            <span class="text-gray-400 flex items-center mx-2">指揮棒</span>
                        </div>
                    </div>
                </div>
                
                <!-- 返回按鈕 -->
                <div class="flex justify-center mt-6">
                    <button id="exit-tutorial" class="elegant-button">
                        返回選單
                    </button>
                </div>
            </div>

            <!-- 音樂播放器（隱藏） -->
            <audio id="game-audio" class="hidden"></audio>
            <audio id="metronome-audio" class="hidden"></audio>
        </div>
    </div>
    
    <!-- 彈出提示框 - 故事模式 -->
    <div id="story-mode-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <div class="text-4xl text-conductor-gold mb-4">🎵</div>
            <h3 class="text-xl font-bold text-conductor-gold mb-3">故事模式開發中</h3>
            <p class="text-gray-300 mb-6">我們正在精心打造更精彩的音樂故事旅程，敬請期待！</p>
            <button id="close-modal-button" class="elegant-button">
                我知道了
            </button>
        </div>
    </div>

    <script>
        // 頁面切換控制與動態音符生成
        document.addEventListener("DOMContentLoaded", function() {
            const coverPage = document.getElementById('cover-page');
            const modeSelectionPage = document.getElementById('mode-selection-page');
            const mainContent = document.getElementById('main-content');
            const startGameButton = document.getElementById('start-game-button');
            const backToCoverButton = document.getElementById('back-to-cover-button');
            const tutorialModeCard = document.getElementById('tutorial-mode-card');
            const performanceModeCard = document.getElementById('performance-mode-card');
            const storyModeCard = document.getElementById('story-mode-card');
            const storyModeModal = document.getElementById('story-mode-modal');
            const closeModalButton = document.getElementById('close-modal-button');
            const connectionStatusDisplay = document.getElementById('connection-status-display');
            const musicNotesContainer = document.getElementById('music-notes-container');
            
            // 生成動態音符
            createDynamicMusicNotes();
            
            // 首頁開始按鈕 - 轉到模式選擇頁
            startGameButton.addEventListener('click', async function() {
                coverPage.classList.add('page-hidden');
                // 清除音符生成
                cleanupMusicNotes();
                
                setTimeout(async () => {
                    // 顯示模式選擇頁
                    modeSelectionPage.classList.remove('page-hidden');
                    
                    // 嘗試連接指揮棒
                    if ('serial' in navigator) {
                        try {
                            // 添加指示訊息
                            connectionStatusDisplay.textContent = '請從彈出對話框選擇Micro:bit設備...';
                            
                            // 請求 serial port
                            port = await navigator.serial.requestPort({
                                // 可選：提供過濾條件，如果您知道 Micro:bit 的 USB 供應商 ID
                                // filters: [{ usbVendorId: 0x0d28 }] // Micro:bit 的 USB 供應商 ID
                            });
                            
                            // 連接設備
                            await port.open({ baudRate: 115200 });
                            
                            // 連接成功提示
                            connectionStatusDisplay.textContent = '已連接指揮棒！可使用指揮棒或空格鍵指揮';
                            connectionStatusDisplay.classList.add('text-green-400');
                            
                            // 開始讀取數據
                            readSerialData();
                        } catch (error) {
                            console.log('使用鍵盤模式：', error);
                            
                            // 根據錯誤類型顯示不同的訊息
                            if (error.name === 'NotFoundError') {
                                connectionStatusDisplay.textContent = '未找到可用的指揮棒設備，使用鍵盤操作';
                            } else if (error.name === 'SecurityError') {
                                connectionStatusDisplay.textContent = '權限被拒絕，使用鍵盤空格鍵或上箭頭進行指揮';
                            } else if (error.message && error.message.includes('No port selected')) {
                                connectionStatusDisplay.textContent = '未選擇設備，使用鍵盤空格鍵或上箭頭進行指揮';
                            } else {
                                connectionStatusDisplay.textContent = '無法連接指揮棒，使用鍵盤空格鍵或上箭頭進行指揮';
                            }
                        }
                    } else {
                        connectionStatusDisplay.textContent = '您的瀏覽器不支援指揮棒連接，使用鍵盤空格鍵指揮';
                    }
                }, 400);
            });
            
            // 返回首頁按鈕
            backToCoverButton.addEventListener('click', function() {
                modeSelectionPage.classList.add('page-hidden');
                
                setTimeout(() => {
                    coverPage.classList.remove('page-hidden');
                    createDynamicMusicNotes();
                }, 400);
            });
            
            // 教學模式卡片
            tutorialModeCard.addEventListener('click', function() {
                modeSelectionPage.classList.add('page-hidden');
                document.body.style.overflow = 'hidden'; // 防止頁面滾動
                
                setTimeout(() => {
                    mainContent.classList.remove('page-hidden');
                    document.body.style.overflow = ''; // 恢復頁面滾動
                    
                    // 顯示教學模式面板，隱藏其他面板
                    tutorialPanel.classList.remove('hidden');
                    gamePanel.classList.add('hidden');
                    setupPanel.classList.add('hidden');
                    resultPanel.classList.add('hidden');
                    connectionPanel.classList.add('hidden');
                    
                    // 初始化節拍器
                    initMetronome();
                    activateLighting();
                    
                    // 確保音頻資源已加載
                    if (!metronomeTickAudio.src) {
                        metronomeTickAudio.src = 'data:audio/wav;base64,UklGRo4DAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0Yb4CAACBgIF/gn2Cf4GBgIB/gH9/gH6AfX9+f4CAf4B+gH2Af3+Af4B+f4B/gH+AgH+Af4B+gIB/gH5/f3+AgH9/f3+AgICAgH9/f4CAgICAf39/gICAgICAf39/gICAgICAf4CAf4CAgICAf4CAf4CAgICAf4CAf4CAgICAf4CAf4CAgICAf4CAf4CAgICAf4B/gICAgH+Af4B/gICAgH+Af4B/gICAgH+Af4B/gICAgH+Af4B/gICAgH+Af4CAgIB/gH+Af4CAgIB/gH+Af4CAgIB/gH+Af4CAgIB/gH+AgICAf4B/gH+AgICAf4B/gH+AgICAf4B/gH+AgICAf4B/gH+AgICAf4B/gICAf4CAf4B/gICAf4CAf4B/gICAf4CAf4B/gICAf4CAf4B/gICAf4CAf4CAgH+AgH+Af4CAgH+AgH+Af4CAgH+AgH+Af4CAgH+AgH+Af4CAgH+AgH+AgIB/gIB/gH+AgIB/gIB/gH+AgIB/gIB/gH+AgIB/gIB/gICAf4CAf4CAgH+AgH+AgIB/gH+AgIB/gIB/gH+AgIB/gH+AgIB/gH+AgIB/gH+AgIB/gH+AgIB/gH+AgIB/gH+AgIB/f4CAgH9/gICAgH9/gICAgH9/gICAgH9/gICAgH9/gICAgH9/gICAgH9/gICAgH9/gICAgH9/gIGAgH5/gYGAgX5+gYGBgn5+gYGBgn5+gYGBgn19gYGCg319gIGCg319gIGCg319gIGCg318gIGDhH18gICDhH18f4CDhH18f4CDhH18f4CDhH18f4CDhH59f4CDhH59f4CDhIB9fn+DhIB9fn+EhYF9fX+EhYF9fX+EhYF9fX+EhYJ+fH6EhoN/fH2DhoSAfHyChYSBfXyChYSBfXyChYSBfXyChISCfn2ChISCfn2ChISCfn2ChISCfn2BhISCfn2BhISCfn2BhISCfn2BhISCfn2BhISCfn6BhIOCfn6BhIOCfn+BhIOCfn+BhIOCfn+BhIKCf3+AhIKCf4CAg4KCgH+Ag4KCgH+Ag4KCgH+Ag4KCgH+Ag4KCgH+Ag4KCgH+Ag4KCgH+Ag4KCgH+AgoKCgICAgoKCgICAgoKCgICAgoKCgICAgoKCgICAgYODgYF/gIKDgoF/gIKDgoGAgIGCgoGAgIGCgoGAgIGCgoGAgIGCgoGAgIGCgoGAgIGCgoGAgIGCgoGAgIGCgoGAgIGCgoGAgH+CgoOBgH9+';
                    }
                    
                    console.log("教學模式已載入");
                }, 400);
            });
            
            // 演奏遊戲卡片
            performanceModeCard.addEventListener('click', function() {
                modeSelectionPage.classList.add('page-hidden');
                document.body.style.overflow = 'hidden'; // 防止頁面滾動
                
                setTimeout(() => {
                    mainContent.classList.remove('page-hidden');
                    document.body.style.overflow = ''; // 恢復頁面滾動
                    
                    // 顯示選曲面板，隱藏其他面板
                    setupPanel.classList.remove('hidden');
                    tutorialPanel.classList.add('hidden');
                    gamePanel.classList.add('hidden');
                    resultPanel.classList.add('hidden');
                    connectionPanel.classList.add('hidden');
                    
                    // 使用默認的鍵盤模式提示
                    connectionStatus.textContent = '使用鍵盤空格鍵或上箭頭進行指揮';
                    connectionStatus.classList.add('text-yellow-500');
                    
                    // 啟動燈光效果
                    activateLighting();
                    
                    console.log("演奏遊戲模式已載入");
                }, 400);
            });
            
            // 故事模式卡片 - 顯示提示
            storyModeCard.addEventListener('click', function() {
                storyModeModal.classList.add('active');
            });
            
            // 關閉故事模式提示
            closeModalButton.addEventListener('click', function() {
                storyModeModal.classList.remove('active');
            });
            
            // 點擊模態框外部區域關閉
            storyModeModal.addEventListener('click', function(e) {
                if (e.target === storyModeModal) {
                    storyModeModal.classList.remove('active');
                }
            });
            
            // 中央向外擴散的音符函數
            function createDynamicMusicNotes() {
                // 清空容器
                musicNotesContainer.innerHTML = '';
                
                // 音符符號庫
                const musicSymbols = ['♩', '♪', '♫', '♬', '𝄞', '𝅘𝅥𝅮', '𝅗𝅥', '𝄐', '𝄑'];
                
                // 創建更多初始音符
                const initialNotes = 10;
                
                // 添加中央擴散的動畫樣式 (無旋轉)
                const centerRadiateStyle = document.createElement('style');
                centerRadiateStyle.textContent = `
                    @keyframes centerRadiate {
                        0% {
                            transform: translate(-50%, -50%) scale(0.5);
                            opacity: 0.6;
                        }
                        100% {
                            transform: translate(-50%, -50%) scale(3);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(centerRadiateStyle);
                
                // 定時生成新的音符
                function createNote() {
                    // 選擇隨機音符符號
                    const symbolIndex = Math.floor(Math.random() * musicSymbols.length);
                    const symbolText = musicSymbols[symbolIndex];
                    
                    // 創建音符元素
                    const note = document.createElement('div');
                    note.className = 'absolute pointer-events-none origin-center';
                    note.textContent = symbolText;
                    
                    // 設置初始位置為中央
                    note.style.left = '50%';
                    note.style.top = '50%';
                    
                    // 移除旋轉角度設置 (僅保留變數以供其他計算使用)
                    const rotationAngle = Math.floor(Math.random() * 360);
                    
                    // 設置隨機基礎大小 (12-24px)
                    const baseSize = Math.floor(Math.random() * 13) + 12;
                    note.style.fontSize = `${baseSize}px`;
                    
                    // 金色效果
                    note.style.color = 'rgba(212, 175, 55, 0.6)';
                    note.style.textShadow = '0 0 8px rgba(212, 175, 55, 0.3)';
                    
                    // 計算擴散方向 (0-360度)
                    const angle = Math.random() * 360;
                    
                    // 計算擴散距離 (螢幕寬度的50-150%)
                    const distance = 50 + Math.random() * 100;
                    
                    // 計算最終位置偏移量
                    const finalX = Math.cos(angle * Math.PI / 180) * distance;
                    const finalY = Math.sin(angle * Math.PI / 180) * distance;
                    
                    // 添加擴散動畫 (無旋轉)
                    const animationName = `centerRadiate_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    const keyframes = `
                    @keyframes ${animationName} {
                        0% {
                            transform: translate(-50%, -50%) scale(0.7);
                            opacity: 0.8;
                        }
                        100% {
                            transform: translate(calc(-50% + ${finalX}vw), calc(-50% + ${finalY}vh)) scale(2.5);
                            opacity: 0;
                        }
                    }`;
                    
                    const style = document.createElement('style');
                    style.textContent = keyframes;
                    document.head.appendChild(style);
                    
                    // 設置動畫持續時間 (8-15秒)
                    const duration = 8 + Math.random() * 7;
                    note.style.animation = `${animationName} ${duration}s cubic-bezier(0.1, 0.2, 0.3, 1) forwards`;
                    
                    // 添加至容器
                    musicNotesContainer.appendChild(note);
                    
                    // 設置動畫結束後移除元素
                    setTimeout(() => {
                        note.remove();
                        style.remove();
                    }, duration * 1000 + 100);
                }
                
                // 初始創建更多音符，間隔更短
                for (let i = 0; i < initialNotes; i++) {
                    setTimeout(() => createNote(), i * 200);
                }
                
                // 設置定時器，以更高頻率生成新的音符
                const noteInterval = setInterval(() => {
                    if (!document.contains(musicNotesContainer)) {
                        clearInterval(noteInterval);
                        return;
                    }
                    createNote();
                }, 800); // 每0.8秒生成一個新音符
                
                // 存儲間隔定時器ID，以便在頁面切換時清除
                musicNotesContainer.dataset.intervalId = noteInterval;
            }
            
            // 頁面切換時清除音符生成定時器
            function cleanupMusicNotes() {
                const musicNotesContainer = document.getElementById('music-notes-container');
                if (musicNotesContainer && musicNotesContainer.dataset.intervalId) {
                    clearInterval(parseInt(musicNotesContainer.dataset.intervalId));
                }
            }
        });
        
        // 全局變數
        let port;
        let reader;
        let reading = false;
        let textDecoder = new TextDecoder();
        let accelerationCount = 0;
        
        // BPM 計算相關變數
        let timestamps = [];
        let lastTimestamp = 0;
        let bpm = 0;
        let lastInterval = 0;
        
        // 信號節流變數
        let lastSignalTime = 0;
        const throttleTime = 420; // 固定為 420 毫秒
        let isProcessing = false;
        
        // 遊戲相關變數
        let gameActive = false;
        let gameStartTime = 0;
        let currentMusic = null;
        let targetBpm = 0;
        let gameTimer = null;
        let isPracticeMode = true; // 初始為練習模式
        let practiceEndTime = 0; // 練習模式結束時間
        const PRACTICE_DURATION = 10; // 練習模式持續10秒
        let currentPlaybackRate = 1.0; // 當前音樂播放速度
        const FAST_PLAYBACK_RATE = 1.15; // 快速播放速度
        const SLOW_PLAYBACK_RATE = 0.85; // 慢速播放速度
        const BPM_THRESHOLD = 0.15; // BPM變化閾值 (15%)
        let gameData = {
            totalBeats: 0,
            accurateBeats: 0, // BPM差異 < 5 的準確節拍
            bpmReadings: []
        };
        let accuracyTimeoutId = null;
        let speedNotificationTimeoutId = null;
        
        // 節拍器相關變數
        let metronomeActive = false;
        let metronomeInterval = null;
        let currentMetronomeBpm = 80;
        let metronomeAudio = document.getElementById('metronome-audio');
        let metronomeTickTimer = null;
        
        // 練習模式相關變數
        let practiceTimestamps = [];
        let practiceLastTimestamp = 0;
        let practiceBpm = 0;
        
        // 舞台燈光和視覺效果
        let stageLighting = document.getElementById('stage-lighting');
        let melodyWave = document.getElementById('melody-wave');
        let isLightingActive = false;

        // 音樂資源設定
        const MUSIC_RESOURCES = {
            newworld: {
                url: './audio/01_Antonín_Dvořák_Symphony_9_E_Minor_II_Largo.mp3',
                duration: 180,
                bpm: 55,
                title: '德弗札克：新世界交響曲 (第二樂章)',
                comment: '深沉優美的慢板旋律，彷彿將聽眾帶入遙遠的新大陸，充滿懷鄉與冥想的氛圍'
            },
            ode: {
                url: './audio/02_Beethoven_Joy.mp3',
                duration: 180,
                bpm: 115,
                title: '貝多芬：第九交響曲 (歡樂頌)',
                comment: '氣勢磅礡的合唱交響樂，象徵人類團結與和平的永恆頌歌，充滿喜悅與力量'
            },
            spring: {
                url: './audio/03_Vivaldi_Spring.mp3',
                duration: 180,
                bpm: 85,
                title: '韋瓦第：四季 (春)',
                comment: '明亮歡快的小提琴協奏曲，生動描繪春天的活力與大自然蘇醒的景象'
            }
        };

        // DOM 元素
        const connectionStatus = document.getElementById('connection-status');
        const connectionPanel = document.getElementById('connection-panel');
        const setupPanel = document.getElementById('setup-panel');
        const gamePanel = document.getElementById('game-panel');
        const resultPanel = document.getElementById('result-panel');
        const tutorialPanel = document.getElementById('tutorial-panel');
        const musicSelect = document.getElementById('music-select');
        const startMusicButton = document.getElementById('start-music-button');
        const stopGameButton = document.getElementById('stop-game-button');
        const playAgainButton = document.getElementById('play-again-button');
        const gameAudio = document.getElementById('game-audio');
        const currentBpmDisplay = document.getElementById('current-bpm');
        const targetBpmDisplay = document.getElementById('target-bpm');
        const bpmDiffDisplay = document.getElementById('bpm-diff');
        const bpmIndicator = document.getElementById('bpm-indicator');
        const accuracyBar = document.getElementById('accuracy-bar');
        const accuracyPercent = document.getElementById('accuracy-percent');
        const accuracyText = document.getElementById('accuracy-text');
        const progressBar = document.getElementById('progress-bar');
        const timeDisplay = document.getElementById('time-display');

        // 節拍器元素
        const bpmSlider = document.getElementById('bpm-slider');
        const bpmValue = document.getElementById('bpm-value');
        const startMetronomeButton = document.getElementById('start-metronome');
        const metronomeToggleText = document.getElementById('metronome-toggle-text');
        const metronomeAudioElement = document.getElementById('metronome-audio'); 
        const metronomeTickSound = new Audio('data:audio/wav;base64,UklGRo4DAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0Yb4CAACBgIF/gn2Cf4GBgIB/gH9/gH6AfX9+f4CAf4B+gH2Af3+Af4B+f4B/gH+AgH+Af4B+gIB/gH5/f3+AgH9/f3+AgICAgH9/f4CAgICAf39/gICAgICAf39/gICAgICAf4CAf4CAgICAf4CAf4CAgICAf4CAf4CAgICAf4CAf4CAgICAf4CAf4CAgICAf4B/gICAgH+Af4B/gICAgH+Af4B/gICAgH+Af4B/gICAgH+Af4B/gICAgH+Af4CAgIB/gH+Af4CAgIB/gH+Af4CAgIB/gH+Af4CAgIB/gH+AgICAf4B/gH+AgICAf4B/gH+AgICAf4B/gH+AgICAf4B/gH+AgICAf4B/gICAf4CAf4B/gICAf4CAf4B/gICAf4CAf4B/gICAf4CAf4B/gICAf4CAf4CAgH+AgH+Af4CAgH+AgH+Af4CAgH+AgH+Af4CAgH+AgH+Af4CAgH+AgH+AgIB/gIB/gH+AgIB/gIB/gH+AgIB/gIB/gH+AgIB/gIB/gICAf4CAf4CAgH+AgH+AgIB/gH+AgIB/gIB/gH+AgIB/gH+AgIB/gH+AgIB/gH+AgIB/gH+AgIB/gH+AgIB/gH+AgIB/f4CAgH9/gICAgH9/gICAgH9/gICAgH9/gICAgH9/gICAgH9/gICAgH9/gICAgH9/gICAgH9/gIGAgH5/gYGAgX5+gYGBgn5+gYGBgn5+gYGBgn19gYGCg319gIGCg319gIGCg319gIGCg318gIGDhH18gICDhH18f4CDhH18f4CDhH18f4CDhH18f4CDhH59f4CDhH59f4CDhIB9fn+DhIB9fn+EhYF9fX+EhYF9fX+EhYF9fX+EhYJ+fH6EhoN/fH2DhoSAfHyChYSBfXyChYSBfXyChYSBfXyChISCfn2ChISCfn2ChISCfn2ChISCfn2BhISCfn2BhISCfn2BhISCfn2BhISCfn2BhISCfn6BhIOCfn6BhIOCfn+BhIOCfn+BhIOCfn+BhIKCf3+AhIKCf4CAg4KCgH+Ag4KCgH+Ag4KCgH+Ag4KCgH+Ag4KCgH+Ag4KCgH+Ag4KCgH+Ag4KCgH+AgoKCgICAgoKCgICAgoKCgICAgoKCgICAgoKCgICAgYODgYF/gIKDgoF/gIKDgoGAgIGCgoGAgIGCgoGAgIGCgoGAgIGCgoGAgIGCgoGAgIGCgoGAgIGCgoGAgIGCgoGAgIGCgoGAgH+CgoOBgH9+');
        const metronomeTickAudio = new Audio('data:audio/wav;base64,UklGRo4DAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0Yb4CAACBgIF/gn2Cf4GBgIB/gH9/gH6AfX9+f4CAf4B+gH2Af3+Af4B+f4B/gH+AgH+Af4B+gIB/gH5/f3+AgH9/f3+AgICAgH9/f4CAgICAf39/gICAgICAf39/gICAgICAf4CAf4CAgICAf4CAf4CAgICAf4CAf4CAgICAf4CAf4CAgICAf4CAf4CAgICAf4B/gICAgH+Af4B/gICAgH+Af4B/gICAgH+Af4B/gICAgH+Af4B/gICAgH+Af4CAgIB/gH+Af4CAgIB/gH+Af4CAgIB/gH+Af4CAgIB/gH+AgICAf4B/gH+AgICAf4B/gH+AgICAf4B/gH+AgICAf4B/gH+AgICAf4B/gICAf4CAf4B/gICAf4CAf4B/gICAf4CAf4B/gICAf4CAf4B/gICAf4CAf4CAgH+AgH+Af4CAgH+AgH+Af4CAgH+AgH+Af4CAgH+AgH+Af4CAgH+AgH+AgIB/gIB/gH+AgIB/gIB/gH+AgIB/gIB/gH+AgIB/gIB/gICAf4CAf4CAgH+AgH+AgIB/gH+AgIB/gIB/gH+AgIB/gH+AgIB/gH+AgIB/gH+AgIB/gH+AgIB/gH+AgIB/gH+AgIB/f4CAgH9/gICAgH9/gICAgH9/gICAgH9/gICAgH9/gICAgH9/gICAgH9/gICAgH9/gICAgH9/gIGAgH5/gYGAgX5+gYGBgn5+gYGBgn5+gYGBgn19gYGCg319gIGCg319gIGCg319gIGCg318gIGDhH18gICDhH18f4CDhH18f4CDhH18f4CDhH18f4CDhH59f4CDhH59f4CDhIB9fn+DhIB9fn+EhYF9fX+EhYF9fX+EhYF9fX+EhYJ+fH6EhoN/fH2DhoSAfHyChYSBfXyChYSBfXyChYSBfXyChISCfn2ChISCfn2ChISCfn2ChISCfn2BhISCfn2BhISCfn2BhISCfn2BhISCfn2BhISCfn6BhIOCfn6BhIOCfn+BhIOCfn+BhIOCfn+BhIKCf3+AhIKCf4CAg4KCgH+Ag4KCgH+Ag4KCgH+Ag4KCgH+Ag4KCgH+Ag4KCgH+Ag4KCgH+Ag4KCgH+AgoKCgICAgoKCgICAgoKCgICAgoKCgICAgoKCgICAgYODgYF/gIKDgoF/gIKDgoGAgIGCgoGAgIGCgoGAgIGCgoGAgIGCgoGAgIGCgoGAgIGCgoGAgIGCgoGAgIGCgoGAgIGCgoGAgH+CgoOBgH9+');
        const exitTutorialButton = document.getElementById('exit-tutorial');
        const metronomeAudioContext = new (window.AudioContext || window.webkitAudioContext)();
        const bpmExamples = document.querySelectorAll('.bpm-example');
        
        // 練習面板元素
        const practiceTargetBpm = document.getElementById('practice-target-bpm');
        const practiceCurrentBpm = document.getElementById('practice-current-bpm');
        const practiceBpmDiff = document.getElementById('practice-bpm-diff');
        const practiceBpmIndicator = document.getElementById('practice-bpm-indicator');
        const practiceAccuracy = document.getElementById('practice-accuracy');
        const practiceConductorImage = document.getElementById('practice-conductor-image');
        const beatIndicator = document.getElementById('beat-indicator');

        // 為節拍器創建音頻視覺化
        const audioWave = document.getElementById('audio-wave');
        
        for (let i = 0; i < 15; i++) {
            const bar = document.createElement('div');
            bar.className = 'wave-bar';
            audioWave.appendChild(bar);
        }

        // 初始化節拍器
        function initMetronome() {
            // 更新BPM顯示
            bpmValue.textContent = bpmSlider.value;
            currentMetronomeBpm = parseInt(bpmSlider.value);
            practiceTargetBpm.textContent = currentMetronomeBpm;
            
            // 配置節拍器擺動器
            updateMetronomePendulum(currentMetronomeBpm);
            
            // 重置練習模式的數據
            practiceTimestamps = [];
            practiceLastTimestamp = 0;
            practiceBpm = 0;
            practiceCurrentBpm.textContent = '--';
            practiceBpmDiff.textContent = '--';
            practiceBpmIndicator.style.left = '50%';
            practiceAccuracy.textContent = '請開始指揮';
            practiceAccuracy.className = 'accuracy-indicator';
        }

        // 啟動/停止節拍器
        function toggleMetronome() {
            if (metronomeActive) {
                // 停止節拍器
                stopMetronome();
                metronomeToggleText.textContent = '開始';
            } else {
                // 啟動節拍器
                startMetronome();
                metronomeToggleText.textContent = '停止';
            }
        }

        // 開始節拍器
        function startMetronome() {
            if (metronomeActive) return;
            
            metronomeActive = true;
            
            // 獲取當前BPM值
            currentMetronomeBpm = parseInt(bpmSlider.value);
            practiceTargetBpm.textContent = currentMetronomeBpm;
            
            // 設置節拍間隔（毫秒）
            const interval = 60000 / currentMetronomeBpm;
            
            // 更新節拍器擺動動畫
            updateMetronomePendulum(currentMetronomeBpm);
            
            // 啟動節拍器音效
            metronomePlay();
            
            // 設置定時器
            metronomeInterval = setInterval(() => {
                metronomePlay();
            }, interval);
        }

        // 停止節拍器
        function stopMetronome() {
            if (!metronomeActive) return;
            
            metronomeActive = false;
            
            // 清除定時器
            clearInterval(metronomeInterval);
            if (metronomeTickTimer) {
                clearTimeout(metronomeTickTimer);
                metronomeTickTimer = null;
            }
            
            // 停止擺動動畫
            const pendulum = document.getElementById('metronome-pendulum');
            pendulum.classList.remove('active');
            
            // 重置節拍指示器
            beatIndicator.classList.remove('active');
        }

        // 更新節拍器擺動
        function updateMetronomePendulum(bpm) {
            const pendulum = document.getElementById('metronome-pendulum');
            
            // 設置擺動時間（秒）
            const duration = 60 / bpm;
            
            // 更新CSS變數
            pendulum.style.setProperty('--duration', `${duration}s`);
            
            // 啟動擺動動畫
            if (metronomeActive) {
                pendulum.classList.add('active');
            }
        }

        // 節拍器音效播放
        function metronomePlay() {
            // 播放滴答聲音
            metronomeTickAudio.currentTime = 0;
            metronomeTickAudio.play().catch(err => console.log('無法播放音效:', err));
            
            // 觸發波形動畫
            triggerWaveAnimation();
            
            // 節拍指示器效果
            beatIndicator.classList.add('active');
            
            // 清除之前的計時器
            if (metronomeTickTimer) {
                clearTimeout(metronomeTickTimer);
            }
            
            // 設置計時器以移除active類
            metronomeTickTimer = setTimeout(() => {
                beatIndicator.classList.remove('active');
            }, 200);
        }

        // 波形動畫
        function triggerWaveAnimation() {
            // 隨機選擇中間一個bar
            const bars = document.querySelectorAll('.wave-bar');
            const centerIndex = Math.floor(bars.length / 2);
            const range = 2; // 中間幾個波形條
            
            // 清除所有活動波形
            bars.forEach(bar => bar.classList.remove('active'));
            
            // 啟動中間的波形
            for (let i = -range; i <= range; i++) {
                const index = centerIndex + i;
                if (index >= 0 && index < bars.length) {
                    bars[index].classList.add('active');
                    
                    // 錯開移除active類，產生更自然的波動效果
                    setTimeout(() => {
                        bars[index].classList.remove('active');
                    }, 300 + Math.abs(i) * 50);
                }
            }
        }

        // 添加鍵盤控制支持
        document.addEventListener('keydown', function(event) {
            if (gameActive && (event.code === 'Space' || event.code === 'ArrowUp')) {
                event.preventDefault();
                simulateBeat();
            } else if (tutorialPanel.classList.contains('hidden') === false && (event.code === 'Space' || event.code === 'ArrowUp')) {
                // 教學模式中的指揮練習
                event.preventDefault();
                simulatePracticeBeat();
            }
        });
        
        // 模擬指揮棒敲擊 (正式遊戲)
        function simulateBeat() {
            // 節流處理
            const now = performance.now();
            if (now - lastSignalTime < throttleTime) {
                return;
            }
            
            isProcessing = true;
            lastSignalTime = now;
            
            // 處理敲擊
            conductorBeat();
            
            setTimeout(() => {
                isProcessing = false;
            }, 50);
        }
        
        // 模擬指揮棒敲擊 (練習模式)
        function simulatePracticeBeat() {
            // 只有節拍器啟動時才接受指揮
            if (!metronomeActive) {
                practiceAccuracy.textContent = '請先啟動節拍器';
                practiceAccuracy.className = 'accuracy-indicator';
                return;
            }
            
            // 節流處理
            const now = performance.now();
            if (now - lastSignalTime < throttleTime) {
                return;
            }
            
            isProcessing = true;
            lastSignalTime = now;
            
            // 處理練習指揮敲擊
            practiceBeat();
            
            setTimeout(() => {
                isProcessing = false;
            }, 50);
        }

        // 教學模式BPM範例點擊處理
        bpmExamples.forEach(example => {
            example.addEventListener('click', () => {
                const bpm = parseInt(example.dataset.bpm);
                
                // 更新滑塊和數值
                bpmSlider.value = bpm;
                bpmValue.textContent = bpm;
                currentMetronomeBpm = bpm;
                practiceTargetBpm.textContent = bpm;
                
                // 更新節拍器
                if (metronomeActive) {
                    stopMetronome();
                    startMetronome();
                } else {
                    updateMetronomePendulum(currentMetronomeBpm);
                }
                
                // 顯示選中效果
                bpmExamples.forEach(ex => ex.classList.remove('border-conductor-gold'));
                example.classList.add('border-conductor-gold');
                
                // 重置練習模式數據
                practiceTimestamps = [];
                practiceLastTimestamp = 0;
                practiceCurrentBpm.textContent = '--';
                practiceBpmDiff.textContent = '--';
                practiceBpmIndicator.style.left = '50%';
                practiceAccuracy.textContent = '已更新目標BPM';
                practiceAccuracy.className = 'accuracy-indicator';
            });
        });

        // 檢查 Web Serial API 支援
        if (!('serial' in navigator)) {
            connectionStatus.textContent = '您的瀏覽器不支援 Micro:bit 連接。請使用鍵盤操作。';
            connectionStatus.classList.add('text-yellow-500');
        }

        // 啟動燈光效果
        function activateLighting() {
            if (!isLightingActive) {
                stageLighting.classList.add('active');
                isLightingActive = true;
            }
        }
        
        // 觸發旋律波浪動畫
        function triggerMelodyWave() {
            melodyWave.classList.remove('active');
            void melodyWave.offsetWidth; // 觸發重排
            melodyWave.classList.add('active');
        }

        // 事件監聽器
        // BPM滑塊變化
        bpmSlider.addEventListener('input', function() {
            bpmValue.textContent = this.value;
            currentMetronomeBpm = parseInt(this.value);
            practiceTargetBpm.textContent = currentMetronomeBpm;
            
            // 更新節拍器如果它正在運行
            if (metronomeActive) {
                stopMetronome();
                startMetronome();
            } else {
                updateMetronomePendulum(currentMetronomeBpm);
            }
            
            // 重置練習模式數據
            practiceTimestamps = [];
            practiceLastTimestamp = 0;
            practiceCurrentBpm.textContent = '--';
            practiceBpmDiff.textContent = '--';
            practiceBpmIndicator.style.left = '50%';
        });

        // 節拍器開始/停止按鈕
        startMetronomeButton.addEventListener('click', toggleMetronome);

        // 退出教學模式按鈕
        exitTutorialButton.addEventListener('click', function() {
            tutorialPanel.classList.add('hidden');
            mainContent.classList.add('page-hidden');
            stopMetronome();
            
            setTimeout(() => {
                // 顯示模式選擇頁
                document.getElementById('mode-selection-page').classList.remove('page-hidden');
            }, 400);
        });

        // 開始遊戲按鈕
        startMusicButton.addEventListener('click', startGame);
        
        // 停止遊戲按鈕
        stopGameButton.addEventListener('click', endGame);
        
        // 再玩一次按鈕
        playAgainButton.addEventListener('click', resetGame);

        // 讀取串口數據
        async function readSerialData() {
            if (reading) return;
            
            reading = true;
            reader = port.readable.getReader();
            
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    
                    if (done) {
                        break;
                    }
                    
                    // 處理接收到的數據
                    processData(value);
                }
            } catch (error) {
                console.error('讀取錯誤:', error);
            } finally {
                reader.releaseLock();
                reading = false;
                
                // 如果連接還存在，則嘗試再次讀取
                if (port && port.readable) {
                    setTimeout(readSerialData, 100);
                } else {
                    // 更新所有連接狀態顯示
                    connectionStatus.textContent = '連接已斷開，可使用鍵盤操作';
                    connectionStatus.classList.remove('text-green-400');
                    connectionStatus.classList.add('text-yellow-500');
                    
                    document.getElementById('connection-status-display').textContent = '連接已斷開，可使用鍵盤操作';
                    document.getElementById('connection-status-display').classList.remove('text-green-400');
                    
                    // 如果遊戲正在進行，則繼續
                    if (gameActive) {
                        // 不結束遊戲，讓用戶可以使用鍵盤繼續
                    }
                }
            }
        }

        // 處理接收到的數據
        function processData(data) {
            const text = textDecoder.decode(data).trim();
            
            // 檢查是否接收到 "b" 信號
            if (text.includes('b')) {
                // 節流處理 - 忽略節流時間內的連續信號
                const now = performance.now();
                if (now - lastSignalTime < throttleTime) {
                    return;
                }
                
                // 如果正在處理中，也忽略
                if (isProcessing) {
                    return;
                }
                
                isProcessing = true;
                lastSignalTime = now;
                
                // 根據當前模式處理信號
                if (gameActive) {
                    // 遊戲模式指揮
                    conductorBeat();
                } else if (tutorialPanel.classList.contains('hidden') === false && metronomeActive) {
                    // 教學模式指揮練習
                    practiceBeat();
                }
                
                // 設定短時間後重置處理標誌，以確保信號處理完畢
                setTimeout(() => {
                    isProcessing = false;
                }, 50);
            }
        }

        // 練習模式的指揮動作
        function practiceBeat() {
            const now = performance.now();
            
            // 顯示指揮動作圖片 (抬手)
            if (practiceConductorImage) {
                practiceConductorImage.src = './images/conductorback01.png';
                
                // 短暫延遲後恢復原來的姿勢
                setTimeout(() => {
                    practiceConductorImage.src = './images/conductorback02.png';
                }, 350);
            }
            
            // 記錄時間戳以計算平均 BPM
            practiceTimestamps.push(now);
            
            // 保持固定數量的樣本 (最近5個)
            if (practiceTimestamps.length > 5) {
                practiceTimestamps.shift();
            }
            
            // 必須有上一次時間戳才能計算
            if (practiceLastTimestamp) {
                const interval = now - practiceLastTimestamp;
                
                // 只有在合理範圍內的間隔才計算 BPM（300-2000ms 大致對應 30-200 BPM）
                if (interval >= 300 && interval <= 2000) {
                    // 使用計算平均 BPM 的方法
                    practiceBpm = calculatePracticeBPM();
                    
                    // 更新當前 BPM 顯示
                    practiceCurrentBpm.textContent = practiceBpm;
                    practiceCurrentBpm.classList.add('bpm-pulse');
                    setTimeout(() => {
                        practiceCurrentBpm.classList.remove('bpm-pulse');
                    }, 500);
                    
                    // 計算與目標 BPM 的差異
                    const targetBpm = parseInt(practiceTargetBpm.textContent);
                    const bpmDiff = practiceBpm - targetBpm;
                    
                    // 更新 BPM 差異顯示
                    if (bpmDiff > 0) {
                        practiceBpmDiff.textContent = `+${bpmDiff} (過快)`;
                    } else if (bpmDiff < 0) {
                        practiceBpmDiff.textContent = `${bpmDiff} (過慢)`;
                    } else {
                        practiceBpmDiff.textContent = `完美!`;
                    }
                    
                    // 更新 BPM 指示器位置
                    const indicatorPos = Math.max(0, Math.min(100, 50 + (bpmDiff / targetBpm * 50)));
                    practiceBpmIndicator.style.left = `${indicatorPos}%`;
                    
                    // 根據差異程度更新精確度評估
                    updatePracticeAccuracy(Math.abs(bpmDiff), targetBpm);
                }
            }
            
            // 更新最後一次時間戳
            practiceLastTimestamp = now;
        }
        
        // 練習模式計算BPM
        function calculatePracticeBPM() {
            if (practiceTimestamps.length < 2) return 0;
            
            // 計算時間間隔（以毫秒為單位）
            const intervals = [];
            for (let i = 1; i < practiceTimestamps.length; i++) {
                intervals.push(practiceTimestamps[i] - practiceTimestamps[i - 1]);
            }
            
            // 計算平均間隔
            const averageInterval = intervals.reduce((sum, interval) => sum + interval, 0) / intervals.length;
            
            // 轉換為 BPM（每分鐘節拍數）
            return Math.round(60000 / averageInterval);
        }
        
        // 更新練習模式精確度評估
        function updatePracticeAccuracy(bpmDifference, targetBpm) {
            // 計算差異比例
            const diffPercentage = (bpmDifference / targetBpm) * 100;
            
            // 重置所有類別
            practiceAccuracy.classList.remove('accuracy-perfect', 'accuracy-good', 'accuracy-adjust');
            
            // 依據差異比例顯示不同評估
            if (diffPercentage <= 5) {
                practiceAccuracy.textContent = '完美！節奏精確';
                practiceAccuracy.classList.add('accuracy-perfect');
            } else if (diffPercentage <= 10) {
                practiceAccuracy.textContent = '良好！基本同步';
                practiceAccuracy.classList.add('accuracy-good');
            } else {
                practiceAccuracy.textContent = '需調整節奏';
                practiceAccuracy.classList.add('accuracy-adjust');
            }
        }

        // 開始遊戲
        function startGame() {
            const musicKey = musicSelect.value;
            currentMusic = MUSIC_RESOURCES[musicKey];
            targetBpm = currentMusic.bpm;
            
            // 啟動燈光效果
            activateLighting();
            
            // 重置遊戲數據
            gameData = {
                totalBeats: 0,
                accurateBeats: 0,
                bpmReadings: []
            };
            
            // 重置練習模式
            isPracticeMode = true;
            
            // 設置音頻並播放
            gameAudio.src = currentMusic.url;
            gameAudio.onloadedmetadata = () => {
                // 更新界面
                connectionPanel.classList.add('hidden');
                setupPanel.classList.add('hidden');
                gamePanel.classList.remove('hidden');
                
                // 顯示練習模式橫幅
                const practiceBanner = document.getElementById('practice-mode-banner');
                const practiceCountdown = document.getElementById('practice-countdown');
                practiceBanner.classList.remove('hidden');
                practiceCountdown.textContent = PRACTICE_DURATION;
                
                // 設置目標 BPM 顯示
                targetBpmDisplay.textContent = targetBpm;
                currentBpmDisplay.textContent = '--';
                bpmDiffDisplay.textContent = '--';
                
                // 重置 BPM 指示器
                bpmIndicator.style.left = '50%';
                
                // 重置精準度
                accuracyBar.style.width = '0%';
                accuracyPercent.textContent = '0%';
                
                // 重置進度條
                updateProgressBar(0);
                
                // 開始遊戲
                gameActive = true;
                gameStartTime = performance.now();
                gameAudio.play();
                
                // 設置練習結束時間
                practiceEndTime = gameAudio.currentTime + PRACTICE_DURATION;
                
                // 設置遊戲計時器
                const duration = gameAudio.duration;
                updateTimeDisplay(0, duration);
                
                // 設置進度更新定時器
                gameTimer = setInterval(() => {
                    const currentTime = gameAudio.currentTime;
                    const duration = gameAudio.duration;
                    
                    updateProgressBar(currentTime / duration * 100);
                    updateTimeDisplay(currentTime, duration);
                    
                    // 更新練習模式倒計時
                    if (isPracticeMode) {
                        const practiceTimeLeft = Math.max(0, Math.ceil(practiceEndTime - currentTime));
                        practiceCountdown.textContent = practiceTimeLeft;
                        
                        // 練習時間結束
                        if (practiceTimeLeft === 0) {
                            isPracticeMode = false;
                            
                            // 隱藏練習模式提示，顯示轉場動畫和提示
                            practiceBanner.classList.add('hidden');
                            
                            // 重置計分數據，開始正式計分
                            gameData = {
                                totalBeats: 0,
                                accurateBeats: 0,
                                bpmReadings: []
                            };
                            
                            // 顯示開始計分提示
                            showAccuracyFeedback('開始正式計分！', 'text-conductor-gold');
                            
                            // 重置精準度顯示
                            accuracyBar.style.width = '0%';
                            accuracyPercent.textContent = '0%';
                        }
                    }
                    
                    // 檢查遊戲是否結束
                    if (currentTime >= duration) {
                        endGame();
                    }
                }, 100);
            };
        }

        // 計算 BPM - 平均法
        function calculateAverageBPM() {
            if (timestamps.length < 2) return 0;
            
            // 計算時間間隔（以毫秒為單位）
            const intervals = [];
            for (let i = 1; i < timestamps.length; i++) {
                intervals.push(timestamps[i] - timestamps[i - 1]);
            }
            
            // 計算平均間隔
            const averageInterval = intervals.reduce((sum, interval) => sum + interval, 0) / intervals.length;
            
            // 轉換為 BPM（每分鐘節拍數）
            return Math.round(60000 / averageInterval);
        }
        
        // 顯示音樂速度提示
        function showSpeedNotification(text, bgColor) {
            const speedNotification = document.getElementById('speed-notification');
            const speedText = document.getElementById('speed-text');
            
            // 清除之前的 timeout
            if (speedNotificationTimeoutId) {
                clearTimeout(speedNotificationTimeoutId);
            }
            
            // 更新文字和背景色
            speedText.textContent = text;
            speedNotification.style.backgroundColor = bgColor;
            
            // 顯示通知
            speedNotification.classList.remove('hidden');
            speedNotification.classList.add('scale-100');
            
            // 觸發旋律波浪效果
            triggerMelodyWave();
            
            // 設置淡出
            speedNotificationTimeoutId = setTimeout(() => {
                speedNotification.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    speedNotification.classList.add('hidden');
                    speedNotification.classList.remove('scale-95', 'opacity-0');
                }, 300);
            }, 2000);
        }
        
        // 調整音樂播放速度
        function adjustPlaybackRate(newBpm) {
            if (!gameAudio || isPracticeMode) return;
            
            let newRate = 1.0;
            
            // 根據 BPM 差異調整播放速度
            if (newBpm > targetBpm * (1 + BPM_THRESHOLD)) {
                newRate = FAST_PLAYBACK_RATE;
            } else if (newBpm < targetBpm * (1 - BPM_THRESHOLD)) {
                newRate = SLOW_PLAYBACK_RATE;
            }
            
            // 只有當速度改變時才更新
            if (newRate !== currentPlaybackRate) {
                // 更新播放速度
                gameAudio.playbackRate = newRate;
                currentPlaybackRate = newRate;
                
                // 顯示速度變化通知
                if (newRate === FAST_PLAYBACK_RATE) {
                    showSpeedNotification('樂團加速！您的節奏過快', '#FF9800');
                } else if (newRate === SLOW_PLAYBACK_RATE) {
                    showSpeedNotification('樂團減速！您的節奏過慢', '#2196F3');
                } else {
                    showSpeedNotification('樂團跟隨您的領導，節奏恢復', '#4CAF50');
                }
            }
        }
        
        // 指揮動作
        function conductorBeat() {
            accelerationCount++;
            const now = performance.now();
            
            // 顯示指揮動作圖片 (抬手)
            const conductorImage = document.getElementById('conductor-image');
            if (conductorImage) {
                conductorImage.src = './images/conductorback01.png';
                
                // 短暫延遲後恢復原來的姿勢
                setTimeout(() => {
                    conductorImage.src = './images/conductorback02.png';
                }, 350);
            }
            
            // 觸發旋律波浪
            triggerMelodyWave();
            
            // 記錄時間戳以計算平均 BPM
            timestamps.push(now);
            
            // 保持固定數量的樣本 (最近5個)
            if (timestamps.length > 5) {
                timestamps.shift();
            }
            
            let newBpm = 0;
            let interval = 0;
            
            if (lastTimestamp) {
                interval = now - lastTimestamp;
                lastInterval = interval;
                
                // 只有在合理範圍內的間隔才計算 BPM（300-2000ms 大致對應 30-200 BPM）
                if (interval >= 300 && interval <= 2000) {
                    // 使用平均值計算 BPM
                    newBpm = calculateAverageBPM();
                    
                    // 更新當前 BPM 顯示
                    currentBpmDisplay.textContent = newBpm;
                    currentBpmDisplay.classList.add('bpm-pulse');
                    setTimeout(() => {
                        currentBpmDisplay.classList.remove('bpm-pulse');
                    }, 500);
                    
                    // 計算與目標 BPM 的差異
                    const bpmDiff = newBpm - targetBpm;
                    
                    // 更新 BPM 差異顯示
                    if (bpmDiff > 0) {
                        bpmDiffDisplay.textContent = `+${bpmDiff} (過快)`;
                    } else if (bpmDiff < 0) {
                        bpmDiffDisplay.textContent = `${bpmDiff} (過慢)`;
                    } else {
                        bpmDiffDisplay.textContent = `完美!`;
                    }
                    
                    // 更新 BPM 指示器位置
                    const indicatorPos = Math.max(0, Math.min(100, 50 + (bpmDiff / targetBpm * 50)));
                    bpmIndicator.style.left = `${indicatorPos}%`;
                    
                    // BPM 指示器脈動效果
                    bpmIndicator.classList.add('animate-pulse');
                    setTimeout(() => {
                        bpmIndicator.classList.remove('animate-pulse');
                    }, 500);
                    
                    // 調整音樂播放速度
                    adjustPlaybackRate(newBpm);
                    
                    // 只有在非練習模式下才更新計分
                    if (!isPracticeMode) {
                        // 更新遊戲數據
                        gameData.totalBeats++;
                        gameData.bpmReadings.push(newBpm);
                        
                        // 添加指揮反饋效果
                        document.querySelectorAll('.reactive-indicator').forEach(el => {
                            el.classList.add('active');
                            setTimeout(() => {
                                el.classList.remove('active');
                            }, 300);
                        });
                        
                        // 更新精準度
                        if (Math.abs(bpmDiff) <= 5) {
                            gameData.accurateBeats++;
                            showAccuracyFeedback('精彩！完美節奏', 'text-green-400');
                        } else if (Math.abs(bpmDiff) <= 10) {
                            showAccuracyFeedback('樂團跟隨您的指揮', 'text-yellow-400');
                        } else {
                            showAccuracyFeedback('調整您的指揮節奏', 'text-red-400');
                        }
                        
                        // 計算並更新精準度百分比
                        const accuracy = (gameData.accurateBeats / gameData.totalBeats * 100).toFixed(0);
                        accuracyBar.style.width = `${accuracy}%`;
                        accuracyPercent.textContent = `${accuracy}%`;
                    } else {
                        // 練習模式下的反饋
                        if (Math.abs(bpmDiff) <= 5) {
                            showAccuracyFeedback('感受樂曲的脈動...', 'text-blue-400');
                        } else if (Math.abs(bpmDiff) <= 10) {
                            showAccuracyFeedback('尋找音樂的節奏...', 'text-blue-400');
                        } else {
                            showAccuracyFeedback('熟悉樂團的呼吸...', 'text-blue-400');
                        }
                    }
                }
            }
            
            // 更新最後一次時間戳
            lastTimestamp = now;
        }

        // 顯示精準度反饋
        function showAccuracyFeedback(text, colorClass) {
            // 清除之前的 timeout
            if (accuracyTimeoutId) {
                clearTimeout(accuracyTimeoutId);
            }
            
            // 移除之前的顏色類並添加新類
            accuracyText.className = 'accuracy-text transition-colors ' + colorClass;
            accuracyText.textContent = text;
            accuracyText.classList.add('show');
            
            // 設置淡出
            accuracyTimeoutId = setTimeout(() => {
                accuracyText.classList.remove('show');
            }, 1500);
        }

        // 更新進度條
        function updateProgressBar(percent) {
            progressBar.style.width = `${percent}%`;
        }

        // 更新時間顯示
        function updateTimeDisplay(currentTime, duration) {
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };
            
            timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
        }

        // 結束遊戲
        function endGame() {
            // 停止音樂和計時器
            gameAudio.pause();
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }
            
            // 標記遊戲結束
            gameActive = false;
            
            // 更新界面
            gamePanel.classList.add('hidden');
            resultPanel.classList.remove('hidden');
            
            // 計算遊戲結果
            const totalBeats = gameData.totalBeats;
            const accurateBeats = gameData.accurateBeats;
            const accuracy = totalBeats > 0 ? (accurateBeats / totalBeats * 100).toFixed(0) : 0;
            
            // 計算平均 BPM
            let averageBpm = 0;
            if (gameData.bpmReadings.length > 0) {
                averageBpm = Math.round(
                    gameData.bpmReadings.reduce((sum, bpm) => sum + bpm, 0) / gameData.bpmReadings.length
                );
            }
            
            // 設置結果標題和評級
            let resultTitle = '';
            let resultComment = '';
            
            if (accuracy >= 90) {
                resultTitle = '大師級指揮！';
                resultComment = '您的藝術風采如暴風般席捲全場，樂團在您的指揮下綻放最璀璨的光芒！';
            } else if (accuracy >= 70) {
                resultTitle = '精湛指揮家！';
                resultComment = '您對音樂的理解與感染力讓樂團與您心靈相通，演繹出動人的樂章！';
            } else if (accuracy >= 50) {
                resultTitle = '有潛力的指揮家';
                resultComment = '您具備自然的音樂天賦，隨著經驗的累積，終將成就非凡的指揮生涯！';
            } else {
                resultTitle = '初學指揮家';
                resultComment = '音樂是一段美麗的旅程，持續練習與感受，您將發現指揮的無窮樂趣！';
            }
            
            // 更新結果面板
            document.getElementById('result-title').textContent = resultTitle;
            document.getElementById('result-score').textContent = `${accuracy}%`;
            document.getElementById('result-target-bpm').textContent = targetBpm;
            document.getElementById('result-average-bpm').textContent = averageBpm || '--';
            document.getElementById('result-accurate-beats').textContent = accurateBeats;
            document.getElementById('result-total-beats').textContent = totalBeats;
            document.getElementById('result-comment').textContent = resultComment;
        }

        // 重置遊戲
        function resetGame() {
            // 隱藏結果面板
            resultPanel.classList.add('hidden');
            
            // 隱藏整個內容頁面
            mainContent.classList.add('page-hidden');
            
            // 顯示模式選擇頁
            setTimeout(() => {
                document.getElementById('mode-selection-page').classList.remove('page-hidden');
            }, 400);
            
            // 重置遊戲數據
            lastTimestamp = 0;
            accelerationCount = 0;
            gameData = {
                totalBeats: 0,
                accurateBeats: 0,
                bpmReadings: []
            };
        }
    </script>
</body>
</html>
